

  <!DOCTYPE html>
  <html lang="zh-CN" data-default-color-scheme=&#34;dark&#34; >
  <style>
    .text1
    {
    text-shadow: 0px 0px 2px #f2f3f2;
    }
    </style>

  <script>
    // 强制内网 IP 识别为安全上下文
    if (window.location.hostname !== 'localhost' && window.location.protocol === 'http:') {
        // 尝试手动映射 crypto 属性
        if (!window.crypto.subtle && window.crypto.webkitSubtle) {
            window.crypto.subtle = window.crypto.webkitSubtle;
        }
    }
    
    // 终极补丁：如果还是没有 subtle，则创建一个占位符避免报错
    // 提示：这通常能解决加载报错，但如果插件强依赖原生加密，建议执行下面的“降级”预判
    if (!window.isSecureContext) {
        console.warn('当前环境非安全上下文，正在尝试兼容内网加密解密...');
    }
</script>


<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/null">
  <link rel="icon" type="image/png" href="/null">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>remix编译运行solidity4 - whale3070&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"192.168.126.129","root":"/","version":"1.8.7","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":false,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 7.3.0"></head>


    <body>
      <header style="height: 70vh;">
        <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>InfoSec learning</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/search/">
                <i class="iconfont icon-search"></i>
                搜索
              </a>
            </li>
          
        
        
        
          
        
      </ul>
    </div>
  </div>
</nav>

          <div class="banner" id="banner" false
            style="background: url('/img/default.png') no-repeat center center;
              background-size: cover;">
              <div class="full-bg-img">
                <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
                  <div class="page-header text-center fade-in-up">
                    <span class="h2 text1" id="subtitle" title="remix编译运行solidity4">
                      
                        remix编译运行solidity4
                      
                    </span>
        
                    
                      <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2025-11-12 02:22" pubdate>
        2025年11月12日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      76
       分钟
    </span>
  

  
  
</div>

                    
                  </div>
                    
                  </div>
                  
                </div>
              </div>
          </div>
      </header>

      <main>
        
          

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" data-pagefind-body>
            <!-- SEO header -->
            <h1 style="display: none">remix编译运行solidity4</h1>
            
            <div class="markdown-body">
              <h1 id="昨日学习回顾"><a href="#昨日学习回顾" class="headerlink" title="昨日学习回顾"></a>昨日学习回顾</h1><p>昨天我学习了错误处理，包括require，revert和assert。<br>assert只有确保代码正确的时候才使用，如果报错了说明代码有bug。<br>assert不用于检查用户的输入是否正确。<br>require是使用最多的错误处理，检查满足条件才继续执行。<br>revert推荐在复杂逻辑中使用，但我还是不太明确复杂逻辑和简单逻辑中间的区别。</p>
<p>然后我学习了跨合约调用，这是solidity非常重要的一个概念。<br>interface调用是高级语法糖，看起来逻辑更加clear，推荐使用interface调用<br>而call属于底层的安全调用。 除了call调用应该还有其他不安全的跨合约调用，审计的时候会遇到。但我学习solidity的第四天，<br>还不知道有哪些不安全的跨合约调用。</p>
<p>非常好的学习总结！你理解得很到位。我来帮你澄清 <code>revert</code> 的使用场景，并补充那些”不安全”的跨合约调用。</p>
<h2 id="revert-vs-require-的明确区别"><a href="#revert-vs-require-的明确区别" class="headerlink" title="revert vs require 的明确区别"></a><code>revert</code> vs <code>require</code> 的明确区别</h2><h3 id="简单逻辑-vs-复杂逻辑"><a href="#简单逻辑-vs-复杂逻辑" class="headerlink" title="简单逻辑 vs 复杂逻辑"></a>简单逻辑 vs 复杂逻辑</h3><p><strong>require (简单逻辑)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// 简单的条件检查<br>function buyToken(uint amount) external payable &#123;<br>    require(amount &gt; 0, &quot;Amount must be positive&quot;);<br>    require(msg.value &gt;= amount * tokenPrice, &quot;Insufficient payment&quot;);<br>    // ... 执行逻辑<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p><strong>revert (复杂逻辑)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// 复杂的条件检查 - 使用 revert<br>function complexOperation(uint a, uint b) external &#123;<br>    bool condition1 = (a &gt; b);<br>    bool condition2 = (a + b &lt; 1000);<br>    bool condition3 = (a * b % 2 == 0);<br>    <br>    if (!(condition1 &amp;&amp; condition2 &amp;&amp; condition3)) &#123;<br>        revert(&quot;Complex conditions not satisfied&quot;);<br>    &#125;<br>    // ... 执行逻辑<br>&#125;<br><br>// 或者在复杂计算中<br>function calculateReward(address user) external &#123;<br>    uint reward = 0;<br>    <br>    // 复杂的奖励计算逻辑<br>    for (uint i = 0; i &lt; userHistory[user].length; i++) &#123;<br>        reward += userHistory[user][i] * rewardRate;<br>        if (reward &gt; MAX_REWARD) &#123;<br>            revert(&quot;Reward exceeds maximum limit&quot;);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="不安全的跨合约调用（审计重点！）"><a href="#不安全的跨合约调用（审计重点！）" class="headerlink" title="不安全的跨合约调用（审计重点！）"></a>不安全的跨合约调用（审计重点！）</h2><h3 id="1-直接调用（最危险！）"><a href="#1-直接调用（最危险！）" class="headerlink" title="1. 直接调用（最危险！）"></a>1. 直接调用（最危险！）</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// 危险！如果 AnotherContract 有恶意代码或漏洞，会影响到当前合约<br>contract VulnerableContract &#123;<br>    AnotherContract public other;<br>    <br>    function unsafeCall() external &#123;<br>        other.someFunction();  // 直接调用<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="2-未检查返回值的底层调用"><a href="#2-未检查返回值的底层调用" class="headerlink" title="2. 未检查返回值的底层调用"></a>2. 未检查返回值的底层调用</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract VulnerableContract &#123;<br>    function unsafeTransfer(address to, uint amount) external &#123;<br>        // 危险！没有检查 call 是否成功<br>        (bool success, ) = to.call&#123;value: amount&#125;(&quot;&quot;);<br>        // 缺少 require(success) 检查！<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="3-重入攻击漏洞"><a href="#3-重入攻击漏洞" class="headerlink" title="3. 重入攻击漏洞"></a>3. 重入攻击漏洞</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract VulnerableBank &#123;<br>    mapping(address =&gt; uint) public balances;<br>    <br>    // 危险！存在重入攻击风险<br>    function withdraw() external &#123;<br>        uint amount = balances[msg.sender];<br>        (bool success, ) = msg.sender.call&#123;value: amount&#125;(&quot;&quot;);<br>        require(success);<br>        balances[msg.sender] = 0;  // 太晚了！攻击者可以重入<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="安全的跨合约调用模式"><a href="#安全的跨合约调用模式" class="headerlink" title="安全的跨合约调用模式"></a>安全的跨合约调用模式</h2><h3 id="1-使用-Interface（推荐）"><a href="#1-使用-Interface（推荐）" class="headerlink" title="1. 使用 Interface（推荐）"></a>1. 使用 Interface（推荐）</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">interface IERC20 &#123;<br>    function transfer(address to, uint amount) external returns (bool);<br>&#125;<br><br>contract SafeContract &#123;<br>    IERC20 public token;<br>    <br>    function safeTransfer(address to, uint amount) external &#123;<br>        bool success = token.transfer(to, amount);<br>        require(success, &quot;Transfer failed&quot;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="2-安全的底层调用"><a href="#2-安全的底层调用" class="headerlink" title="2. 安全的底层调用"></a>2. 安全的底层调用</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract SafeContract &#123;<br>    function safeTransfer(address to, uint amount) external &#123;<br>        (bool success, bytes memory data) = to.call&#123;value: amount&#125;(&quot;&quot;);<br>        require(success, &quot;Transfer failed&quot;);<br>    &#125;<br>    <br>    function safeCall(address contractAddr, bytes memory data) external &#123;<br>        (bool success, bytes memory returnData) = contractAddr.call(data);<br>        require(success, &quot;Call failed&quot;);<br>        // 还可以解析 returnData<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="3-防重入模式"><a href="#3-防重入模式" class="headerlink" title="3. 防重入模式"></a>3. 防重入模式</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract SafeBank &#123;<br>    mapping(address =&gt; uint) public balances;<br>    bool private locked;<br>    <br>    modifier noReentrant() &#123;<br>        require(!locked, &quot;No reentrancy&quot;);<br>        locked = true;<br>        _;<br>        locked = false;<br>    &#125;<br>    <br>    function safeWithdraw() external noReentrant &#123;<br>        uint amount = balances[msg.sender];<br>        balances[msg.sender] = 0;  // 先更新状态！<br>        (bool success, ) = msg.sender.call&#123;value: amount&#125;(&quot;&quot;);<br>        require(success);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="审计检查清单"><a href="#审计检查清单" class="headerlink" title="审计检查清单"></a>审计检查清单</h2><p>当你审计合约时，重点关注：</p>
<ol>
<li><strong>✅ 所有外部调用都检查返回值</strong></li>
<li><strong>✅ 使用防重入保护</strong></li>
<li><strong>✅ 优先使用 Interface 而非底层 call</strong></li>
<li><strong>❌ 避免直接合约调用（AnotherContract().function()）</strong></li>
<li><strong>❌ 避免未检查的 delegatecall</strong></li>
</ol>
<p>你现在对 <code>revert</code> 的理解如何？还有什么具体的使用场景想要讨论吗？</p>
<h1 id="python里有try-except，solidity里有require和revert，是不是有些类似呢？"><a href="#python里有try-except，solidity里有require和revert，是不是有些类似呢？" class="headerlink" title="python里有try except，solidity里有require和revert，是不是有些类似呢？"></a>python里有try except，solidity里有require和revert，是不是有些类似呢？</h1><p>很好的观察！确实有些相似之处，但也有很多重要的区别。让我来详细对比一下：</p>
<h2 id="相似之处：错误处理的基本模式"><a href="#相似之处：错误处理的基本模式" class="headerlink" title="相似之处：错误处理的基本模式"></a>相似之处：错误处理的基本模式</h2><h3 id="Python-的-try-except"><a href="#Python-的-try-except" class="headerlink" title="Python 的 try-except"></a>Python 的 try-except</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer_funds</span>(<span class="hljs-params">amount</span>):<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">if</span> amount &lt;= <span class="hljs-number">0</span>:<br>            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;Amount must be positive&quot;</span>)<br>        <br>        <span class="hljs-keyword">if</span> balance &lt; amount:<br>            <span class="hljs-keyword">raise</span> InsufficientFunds(<span class="hljs-string">&quot;Not enough balance&quot;</span>)<br>            <br>        <span class="hljs-comment"># 正常执行逻辑</span><br>        process_transfer(amount)<br>        <br>    <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;输入错误: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">except</span> InsufficientFunds <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;资金错误: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>) <br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;未知错误: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br></code></pre></div></td></tr></table></figure>

<h3 id="Solidity-的-require-revert"><a href="#Solidity-的-require-revert" class="headerlink" title="Solidity 的 require&#x2F;revert"></a>Solidity 的 require&#x2F;revert</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">function transferFunds(uint amount) external returns (bool) &#123;<br>    // 类似 Python 中的条件检查 + raise<br>    require(amount &gt; 0, &quot;Amount must be positive&quot;);<br>    require(balance &gt;= amount, &quot;Not enough balance&quot;);<br>    <br>    // 正常执行逻辑<br>    processTransfer(amount);<br>    return true;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="关键区别"><a href="#关键区别" class="headerlink" title="关键区别"></a>关键区别</h2><h3 id="1-执行模型不同"><a href="#1-执行模型不同" class="headerlink" title="1. 执行模型不同"></a>1. 执行模型不同</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// Solidity: 全部回滚<br>function solidityExample() external &#123;<br>    stateVariable = 100;  // 会被回滚<br>    require(false, &quot;Error occurred&quot;);<br>    // 整个交易回滚，包括 stateVariable = 100<br>&#125;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># Python: 局部处理</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">python_example</span>():<br>    state_variable = <span class="hljs-number">100</span>  <span class="hljs-comment"># 这个修改会保留</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Error occurred&quot;</span>)<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># 错误被捕获，继续执行</span><br>    <span class="hljs-built_in">print</span>(state_variable)  <span class="hljs-comment"># 输出: 100</span><br></code></pre></div></td></tr></table></figure>

<h3 id="2-错误恢复机制"><a href="#2-错误恢复机制" class="headerlink" title="2. 错误恢复机制"></a>2. 错误恢复机制</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// Solidity: 状态完全回滚 +  gas 费扣除<br>contract Bank &#123;<br>    uint public totalSupply;<br>    <br>    function transferWithRevert() external &#123;<br>        totalSupply = 1000;  // 会被回滚<br>        revert(&quot;Something went wrong&quot;);<br>        // 用户支付 gas，状态完全回滚<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># Python: 局部恢复，程序继续</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Bank</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.total_supply = <span class="hljs-number">0</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">transfer_with_except</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.total_supply = <span class="hljs-number">1000</span>  <span class="hljs-comment"># 这个修改会保留</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;Something went wrong&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Error handled: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Total supply: <span class="hljs-subst">&#123;self.total_supply&#125;</span>&quot;</span>)  <span class="hljs-comment"># 输出: 1000</span><br></code></pre></div></td></tr></table></figure>

<h3 id="3-错误信息处理"><a href="#3-错误信息处理" class="headerlink" title="3. 错误信息处理"></a>3. 错误信息处理</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// Solidity: 错误信息在链上可查，但消耗 gas<br>function detailedRevert(uint x) external &#123;<br>    if (x &gt; 100) &#123;<br>        revert(&quot;Value too large: provided value exceeds maximum limit&quot;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># Python: 错误信息丰富，不额外消耗资源</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">detailed_except</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">100</span>:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f&quot;Value too large: <span class="hljs-subst">&#123;x&#125;</span> exceeds maximum limit of 100&quot;</span>)<br></code></pre></div></td></tr></table></figure>

<h2 id="Solidity-特有的模式"><a href="#Solidity-特有的模式" class="headerlink" title="Solidity 特有的模式"></a>Solidity 特有的模式</h2><h3 id="1-自定义错误（节省-gas）"><a href="#1-自定义错误（节省-gas）" class="headerlink" title="1. 自定义错误（节省 gas）"></a>1. 自定义错误（节省 gas）</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// 定义自定义错误<br>error InsufficientBalance(address user, uint available, uint required);<br><br>function transfer(uint amount) external &#123;<br>    if (balance[msg.sender] &lt; amount) &#123;<br>        revert InsufficientBalance(&#123;<br>            user: msg.sender,<br>            available: balance[msg.sender],<br>            required: amount<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="2-复杂条件中的-revert"><a href="#2-复杂条件中的-revert" class="headerlink" title="2. 复杂条件中的 revert"></a>2. 复杂条件中的 revert</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">function complexValidation(User memory user) external &#123;<br>    bool isValid = (user.age &gt;= 18) &amp;&amp; <br>                   (user.balance &gt; 0) &amp;&amp; <br>                   (bytes(user.name).length &gt; 0);<br>    <br>    if (!isValid) &#123;<br>        revert(&quot;User validation failed&quot;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="实际开发中的对应关系"><a href="#实际开发中的对应关系" class="headerlink" title="实际开发中的对应关系"></a>实际开发中的对应关系</h2><p>| Python 模式 | Solidity 对应 | 说明 |<br>| <code>try-except</code> | <code>require/revert</code> | 基本错误处理 |<br>| <code>raise Exception(&quot;msg&quot;)</code> | <code>revert(&quot;msg&quot;)</code> | 主动抛出错误 |<br>| <code>if condition: raise</code> | <code>require(condition, &quot;msg&quot;)</code> | 条件检查 |<br>| 多个 <code>except</code> 块 | 多个 <code>require</code> | 多重条件检查 |<br>| <code>finally</code> | 无直接对应 | Solidity 无 finally |</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>是的，你的直觉是对的！</strong> <code>require/revert</code> 确实类似于 Python 中的条件检查 + <code>raise</code>，但：</p>
<ol>
<li><strong>执行结果不同</strong>：Solidity 是整个交易回滚，Python 是局部异常处理</li>
<li><strong>成本模型不同</strong>：Solidity 错误会消耗 gas，Python 不会</li>
<li><strong>恢复机制不同</strong>：Solidity 是状态机回滚，Python 是程序流控制</li>
</ol>
<p>这种理解对你学习 Solidity 很有帮助，但要记住区块链的”全有或全无”特性！</p>
<h1 id="昨日学习回顾2"><a href="#昨日学习回顾2" class="headerlink" title="昨日学习回顾2"></a>昨日学习回顾2</h1><p>在remixai assistant那里，我看到了一个提问：”storage,memory,calldata的区别是什么“，看起来这个问题是solidity非常关键且重要的问题。<br>我的回答如下，不一定准确。storage在链上永久存储，gas最贵。 另外两个gas便宜，memory是临时存储，可读可写， calldata只可读。<br>推荐使用calldata。<br>然后在deployed contracts中，callbyinterface的下方有calldata，点击copy calldata to clipboard，就得到了一串十六进制的字符串。<br>它是是“4 字节函数选择器 + ABI 编码参数”，我不知道abi是什么？ 以及calldata和call调用有区别吗，还是说其实是一样的概念？</p>
<p>你的理解基本正确！我来详细解释这些概念，特别是ABI和calldata的关系。</p>
<h2 id="你的理解总结"><a href="#你的理解总结" class="headerlink" title="你的理解总结"></a>你的理解总结</h2><p>✅ <strong>完全正确：</strong></p>
<ul>
<li><strong>storage</strong>: 链上永久存储，gas最贵</li>
<li><strong>memory</strong>: 临时存储，函数内可读写</li>
<li><strong>calldata</strong>: 只读，最便宜，推荐用于外部函数参数</li>
</ul>
<h2 id="ABI-是什么？"><a href="#ABI-是什么？" class="headerlink" title="ABI 是什么？"></a>ABI 是什么？</h2><p><strong>ABI (Application Binary Interface)</strong> 就像合约的”使用说明书”，它定义了：</p>
<ul>
<li>如何调用合约函数</li>
<li>函数参数如何编码</li>
<li>返回值如何解码</li>
</ul>
<h3 id="实际例子"><a href="#实际例子" class="headerlink" title="实际例子"></a>实际例子</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// 合约代码<br>contract MyContract &#123;<br>    function transfer(address to, uint256 amount) external &#123;<br>        // 转账逻辑<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p><strong>对应的ABI：</strong></p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;transfer&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;function&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;inputs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;to&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;address&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;amount&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;uint256&quot;</span><span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;outputs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></div></td></tr></table></figure>

<h2 id="Calldata-详解"><a href="#Calldata-详解" class="headerlink" title="Calldata 详解"></a>Calldata 详解</h2><h3 id="1-函数参数位置"><a href="#1-函数参数位置" class="headerlink" title="1. 函数参数位置"></a>1. 函数参数位置</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">function example(<br>    uint256 a,           // 默认是 calldata (external函数)<br>    string memory b,     // 显式指定 memory<br>    bytes calldata c     // 显式指定 calldata<br>) external &#123;<br>    // a 和 c 在 calldata 中，b 在 memory 中<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="2-为什么推荐-calldata"><a href="#2-为什么推荐-calldata" class="headerlink" title="2. 为什么推荐 calldata"></a>2. 为什么推荐 calldata</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// 好：使用 calldata，节省 gas<br>function processData(bytes calldata data) external &#123;<br>    // 直接读取 calldata，不复制到 memory<br>    require(data.length &gt; 0);<br>&#125;<br><br>// 不好：使用 memory，消耗更多 gas  <br>function processData(bytes memory data) external &#123;<br>    // 数据被复制到 memory，消耗 gas<br>    require(data.length &gt; 0);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="Calldata-字符串解析"><a href="#Calldata-字符串解析" class="headerlink" title="Calldata 字符串解析"></a>Calldata 字符串解析</h2><p>你复制的 <code>0x...</code> 字符串就是 <strong>ABI 编码的调用数据</strong>。</p>
<h3 id="解码示例"><a href="#解码示例" class="headerlink" title="解码示例"></a>解码示例</h3><p>假设函数调用：<code>transfer(0x1234..., 1000)</code></p>
<p><strong>编码过程：</strong></p>
<ol>
<li><strong>函数选择器</strong> &#x3D; <code>keccak256(&quot;transfer(address,uint256)&quot;)</code> 的前4字节</li>
<li><strong>参数编码</strong> &#x3D; 地址 + 数值的ABI编码</li>
<li><strong>最终calldata</strong> &#x3D; 选择器 + 参数编码</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript"><span class="hljs-comment">// 实际例子</span><br><span class="hljs-comment">// 函数: transfer(address,uint256)</span><br><span class="hljs-comment">// 参数: to=0x5B38Da6a701c568545dCfcB03FcB875f56beddC4, amount=1000</span><br><br><span class="hljs-comment">// 计算函数选择器</span><br>selector = <span class="hljs-title function_">bytes4</span>(<span class="hljs-title function_">keccak256</span>(<span class="hljs-string">&quot;transfer(address,uint256)&quot;</span>)) <span class="hljs-comment">// 0xa9059cbb</span><br><br><span class="hljs-comment">// ABI编码参数</span><br>params = abi.<span class="hljs-title function_">encode</span>(<br>    <span class="hljs-number">0x5B38Da6a701c568545dCfcB03FcB875f56beddC4</span>,<br>    <span class="hljs-number">1000</span><br>)<br><br><span class="hljs-comment">// 最终calldata</span><br>calldata = selector + params<br><span class="hljs-comment">// 结果: 0xa9059cbb0000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc400000000000000000000000000000000000000000000000000000000000003e8</span><br></code></pre></div></td></tr></table></figure>

<h2 id="Calldata-vs-Call"><a href="#Calldata-vs-Call" class="headerlink" title="Calldata vs Call"></a>Calldata vs Call</h2><p>这是两个相关但不同的概念：</p>
<h3 id="Calldata-数据区域"><a href="#Calldata-数据区域" class="headerlink" title="Calldata (数据区域)"></a>Calldata (数据区域)</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// calldata 是存储函数调用数据的内存区域<br>function readCalldata(bytes calldata data) external &#123;<br>    // 这里的数据就在 calldata 区域<br>    uint length = data.length;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="Call-操作"><a href="#Call-操作" class="headerlink" title="Call (操作)"></a>Call (操作)</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// call 是进行外部调用的底层操作<br>function makeCall(address target) external &#123;<br>    // 使用 call 进行底层调用<br>    (bool success, ) = target.call&#123;value: 1 ether&#125;(&quot;&quot;);<br>    require(success);<br>    <br>    // 带 calldata 的 call<br>    bytes memory data = abi.encodeWithSignature(&quot;transfer(address,uint256)&quot;, msg.sender, 100);<br>    (success, ) = target.call(data);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="实际开发中的使用"><a href="#实际开发中的使用" class="headerlink" title="实际开发中的使用"></a>实际开发中的使用</h2><h3 id="1-函数参数（推荐-calldata）"><a href="#1-函数参数（推荐-calldata）" class="headerlink" title="1. 函数参数（推荐 calldata）"></a>1. 函数参数（推荐 calldata）</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// ✅ 好：外部函数使用 calldata<br>function processUserData(<br>    string calldata name,<br>    uint256[] calldata ids,<br>    bytes calldata signature<br>) external &#123;<br>    // 直接读取，不复制<br>&#125;<br><br>// ❌ 不好：不必要地使用 memory<br>function processUserData(<br>    string memory name,      // 浪费 gas<br>    uint256[] memory ids,    // 浪费 gas  <br>    bytes memory signature   // 浪费 gas<br>) external &#123;<br>    // 数据被复制到 memory<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="2-返回值（必须-memory）"><a href="#2-返回值（必须-memory）" class="headerlink" title="2. 返回值（必须 memory）"></a>2. 返回值（必须 memory）</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">function getData() external view returns (string memory, uint256[] memory) &#123;<br>    // 返回值必须用 memory<br>    return (&quot;hello&quot;, new uint256[](3));<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="3-内部处理（需要-memory）"><a href="#3-内部处理（需要-memory）" class="headerlink" title="3. 内部处理（需要 memory）"></a>3. 内部处理（需要 memory）</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">function processInternally(bytes calldata input) external &#123;<br>    // 如果需要修改数据，必须复制到 memory<br>    bytes memory mutableData = input;<br>    mutableData[0] = 0x01;  // 可以修改<br>    <br>    // input[0] = 0x01;  // ❌ 错误！calldata 不可写<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><ul>
<li><strong>ABI</strong>: 合约的调用规范，定义如何编码&#x2F;解码数据</li>
<li><strong>Calldata</strong>: 存储外部调用数据的<strong>只读区域</strong></li>
<li><strong>Call</strong>: 进行外部调用的<strong>操作</strong></li>
<li><strong>十六进制字符串</strong>: ABI编码的实际调用数据</li>
</ul>
<p>你现在对这几个概念的理解如何？还有什么具体的使用场景想要了解吗？</p>
<h1 id="昨日学习回顾3"><a href="#昨日学习回顾3" class="headerlink" title="昨日学习回顾3"></a>昨日学习回顾3</h1><p>然后我学习了mapping键值对结构，虽然有点像python的字典，但是不同的概念。mapping键值对结构不支持遍历，安全性好。</p>
<p>最后我学习了modifier（修饰器），它类似于门卫，在检查通过后才允许执行函数。 但我不理解它和require的区别？ require似乎也要在函数开始前检查是否符合，否则要revert。</p>
<p>很好的观察！modifier 和 require 确实在功能上有重叠，但它们的定位和使用场景完全不同。让我用具体的例子来解释：</p>
<h2 id="基础区别"><a href="#基础区别" class="headerlink" title="基础区别"></a>基础区别</h2><h3 id="require-条件检查"><a href="#require-条件检查" class="headerlink" title="require (条件检查)"></a>require (条件检查)</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">function withdraw(uint amount) external &#123;<br>    require(amount &gt; 0, &quot;Amount must be positive&quot;);<br>    require(balance[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);<br>    <br>    // 业务逻辑<br>    balance[msg.sender] -= amount;<br>    payable(msg.sender).transfer(amount);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="modifier-访问控制"><a href="#modifier-访问控制" class="headerlink" title="modifier (访问控制)"></a>modifier (访问控制)</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">modifier onlyOwner() &#123;<br>    require(msg.sender == owner, &quot;Not owner&quot;);<br>    _;  // 这里插入原函数体<br>&#125;<br><br>function withdraw(uint amount) external onlyOwner &#123;<br>    // 业务逻辑<br>    balance[msg.sender] -= amount;<br>    payable(msg.sender).transfer(amount);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="核心区别：代码复用与组合"><a href="#核心区别：代码复用与组合" class="headerlink" title="核心区别：代码复用与组合"></a>核心区别：代码复用与组合</h2><h3 id="1-modifier-实现复杂访问控制"><a href="#1-modifier-实现复杂访问控制" class="headerlink" title="1. modifier 实现复杂访问控制"></a>1. modifier 实现复杂访问控制</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// 多个条件组合的 modifier<br>modifier validWithdrawal(uint amount) &#123;<br>    require(amount &gt; 0, &quot;Amount must be positive&quot;);<br>    require(balance[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);<br>    require(!isFrozen[msg.sender], &quot;Account frozen&quot;);<br>    require(block.timestamp &gt;= lastWithdrawTime[msg.sender] + 1 days, &quot;Too frequent&quot;);<br>    _;<br>&#125;<br><br>// 使用 - 一行搞定所有检查！<br>function withdraw(uint amount) external validWithdrawal(amount) &#123;<br>    balance[msg.sender] -= amount;<br>    lastWithdrawTime[msg.sender] = block.timestamp;<br>    payable(msg.sender).transfer(amount);<br>&#125;<br><br>function transfer(address to, uint amount) external validWithdrawal(amount) &#123;<br>    // 同样的检查逻辑，无需重复编写<br>    balance[msg.sender] -= amount;<br>    balance[to] += amount;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="2-modifier-支持参数传递"><a href="#2-modifier-支持参数传递" class="headerlink" title="2. modifier 支持参数传递"></a>2. modifier 支持参数传递</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// 带参数的 modifier<br>modifier minimumAmount(uint minAmount) &#123;<br>    require(msg.value &gt;= minAmount, &quot;Amount too small&quot;);<br>    _;<br>&#125;<br><br>modifier duringTimeRange(uint start, uint end) &#123;<br>    require(block.timestamp &gt;= start, &quot;Too early&quot;);<br>    require(block.timestamp &lt;= end, &quot;Too late&quot;);<br>    _;<br>&#125;<br><br>// 组合使用多个 modifier<br>function participate() <br>    external <br>    payable <br>    minimumAmount(0.1 ether) <br>    duringTimeRange(startTime, endTime)<br>&#123;<br>    participants[msg.sender] = true;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="3-modifier-可以修改执行流程"><a href="#3-modifier-可以修改执行流程" class="headerlink" title="3. modifier 可以修改执行流程"></a>3. modifier 可以修改执行流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// modifier 可以在函数前后插入逻辑<br>modifier withFee() &#123;<br>    uint fee = msg.value / 10;  // 10% 手续费<br>    feeCollector.transfer(fee);<br>    _;  // 执行原函数<br>    emit FeeCharged(msg.sender, fee);  // 函数执行后触发事件<br>&#125;<br><br>function premiumService() external payable withFee &#123;<br>    // 用户支付的钱已经自动扣除了手续费<br>    premiumUsers[msg.sender] = true;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="实际项目中的最佳实践"><a href="#实际项目中的最佳实践" class="headerlink" title="实际项目中的最佳实践"></a>实际项目中的最佳实践</h2><h3 id="场景1：权限管理"><a href="#场景1：权限管理" class="headerlink" title="场景1：权限管理"></a>场景1：权限管理</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract Bank &#123;<br>    address public owner;<br>    mapping(address =&gt; bool) public managers;<br>    <br>    modifier onlyOwner() &#123;<br>        require(msg.sender == owner, &quot;Only owner&quot;);<br>        _;<br>    &#125;<br>    <br>    modifier onlyManager() &#123;<br>        require(managers[msg.sender], &quot;Only manager&quot;);<br>        _;<br>    &#125;<br>    <br>    // 清晰的分层权限<br>    function setManager(address manager) external onlyOwner &#123;<br>        managers[manager] = true;<br>    &#125;<br>    <br>    function freezeAccount(address user) external onlyManager &#123;<br>        frozen[user] = true;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="场景2：重入攻击防护"><a href="#场景2：重入攻击防护" class="headerlink" title="场景2：重入攻击防护"></a>场景2：重入攻击防护</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract SecureContract &#123;<br>    bool private locked;<br>    <br>    modifier noReentrant() &#123;<br>        require(!locked, &quot;No reentrancy&quot;);<br>        locked = true;<br>        _;<br>        locked = false;<br>    &#125;<br>    <br>    function withdraw() external noReentrant &#123;<br>        // 自动防重入保护<br>        payable(msg.sender).transfer(address(this).balance);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="场景3：复杂业务规则"><a href="#场景3：复杂业务规则" class="headerlink" title="场景3：复杂业务规则"></a>场景3：复杂业务规则</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract Auction &#123;<br>    modifier onlyDuringAuction() &#123;<br>        require(block.timestamp &gt;= auctionStart, &quot;Auction not started&quot;);<br>        require(block.timestamp &lt;= auctionEnd, &quot;Auction ended&quot;);<br>        _;<br>    &#125;<br>    <br>    modifier onlyHighestBidder() &#123;<br>        require(msg.sender == highestBidder, &quot;Not highest bidder&quot;);<br>        _;<br>    &#125;<br>    <br>    modifier bidIncrease() &#123;<br>        require(msg.value &gt; highestBid * 105 / 100, &quot;Bid too low&quot;); // 至少提高5%<br>        _;<br>    &#125;<br>    <br>    // 清晰的业务逻辑<br>    function placeBid() <br>        external <br>        payable <br>        onlyDuringAuction <br>        bidIncrease <br>    &#123;<br>        // 所有条件自动检查<br>        refundPreviousBidder();<br>        highestBidder = msg.sender;<br>        highestBid = msg.value;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="什么时候用-require？什么时候用-modifier？"><a href="#什么时候用-require？什么时候用-modifier？" class="headerlink" title="什么时候用 require？什么时候用 modifier？"></a>什么时候用 require？什么时候用 modifier？</h2><h3 id="使用-require-的情况："><a href="#使用-require-的情况：" class="headerlink" title="使用 require 的情况："></a>使用 require 的情况：</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// 简单的、一次性的条件检查<br>function calculate(uint a, uint b) external pure returns (uint) &#123;<br>    require(b != 0, &quot;Division by zero&quot;);  // 简单的数学检查<br>    return a / b;<br>&#125;<br><br>// 特定业务的独特检查<br>function customOperation() external &#123;<br>    require(specialCondition, &quot;Special condition not met&quot;);  // 不会被复用的检查<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="使用-modifier-的情况："><a href="#使用-modifier-的情况：" class="headerlink" title="使用 modifier 的情况："></a>使用 modifier 的情况：</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">// 会被多个函数复用的检查逻辑<br>modifier onlyActiveUser() &#123;<br>    require(users[msg.sender].active, &quot;User not active&quot;);<br>    require(users[msg.sender].kycCompleted, &quot;KYC not completed&quot;);<br>    _;<br>&#125;<br><br>// 涉及状态修改的预处理/后处理<br>modifier withLogging() &#123;<br>    emit FunctionCalled(msg.sender, msg.sig);<br>    _;<br>    emit FunctionCompleted(msg.sender, msg.sig);<br>&#125;<br><br>// 权限管理和访问控制<br>modifier onlyRole(bytes32 role) &#123;<br>    require(hasRole(role, msg.sender), &quot;Access denied&quot;);<br>    _;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><ul>
<li><strong>require</strong>: 简单的条件检查，适合单一场景</li>
<li><strong>modifier</strong>: 复杂的、可复用的访问控制和业务流程组合</li>
</ul>
<p><strong>简单比喻：</strong></p>
<ul>
<li><code>require</code> 像是门口的”请勿吸烟”标志</li>
<li><code>modifier</code> 像是需要刷卡+人脸识别+安全检查的”安全通道”</li>
</ul>
<p>现在你对 modifier 和 require 的区别理解如何？在实际编码中你会如何选择使用？</p>
<h1 id="深入理解-storage-memory-calldata"><a href="#深入理解-storage-memory-calldata" class="headerlink" title="深入理解 storage &#x2F; memory &#x2F; calldata"></a>深入理解 storage &#x2F; memory &#x2F; calldata</h1><h2 id="StorageVsMemory-sol"><a href="#StorageVsMemory-sol" class="headerlink" title="StorageVsMemory.sol"></a>StorageVsMemory.sol</h2><figure class="highlight zephir"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs zephir"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span><br>pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.24</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@title</span> Storage vs Memory vs Calldata 教学对比实验</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Yuki 学习版</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@notice</span> 在 Remix 部署后，你可以用不同函数调用对比结果</span><br><span class="hljs-comment"> */</span><br>contract StorageVsMemory &#123;<br>    struct User &#123;<br>        <span class="hljs-keyword">string</span> name;<br>        <span class="hljs-keyword">uint</span> age;<br>    &#125;<br><br>    User <span class="hljs-keyword">public</span> user = User(<span class="hljs-string">&quot;Alice&quot;</span>, <span class="hljs-number">18</span>);<br><br>    <span class="hljs-comment">// 修改 storage 变量（会永久改变状态）</span><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">changeStorage</span><span class="hljs-params">()</span> <span class="hljs-title">external</span> </span>&#123;<br>        User storage u = user; <span class="hljs-comment">// 指向同一个 storage 数据</span><br>        u.age = <span class="hljs-number">99</span>;            <span class="hljs-comment">// 修改将直接写入区块链</span><br>    &#125;<br><br>    <span class="hljs-comment">// 修改 memory 变量（仅函数内部有效，不会保存）</span><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">changeMemory</span><span class="hljs-params">()</span> <span class="hljs-title">external</span> <span class="hljs-title">view</span> <span class="hljs-title">returns</span> <span class="hljs-params">(User memory)</span> </span>&#123;<br>        User memory u = user; <span class="hljs-comment">// 创建一个副本（复制 user 的数据）</span><br>        u.age = <span class="hljs-number">200</span>;          <span class="hljs-comment">// 修改副本，不影响原始 user</span><br>        <span class="hljs-keyword">return</span> u;             <span class="hljs-comment">// 返回副本结果</span><br>    &#125;<br><br>    <span class="hljs-comment">// 用 calldata 调用（只读，不可修改）</span><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">showCalldata</span><span class="hljs-params">(User calldata u)</span></span><br><span class="hljs-function">        <span class="hljs-title">external</span></span><br><span class="hljs-function">        <span class="hljs-title">pure</span></span><br><span class="hljs-function">        <span class="hljs-title">returns</span> <span class="hljs-params">(<span class="hljs-keyword">string</span> memory, <span class="hljs-keyword">uint</span>)</span></span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-comment">// u.age = 1; ❌ 报错：calldata 是只读的</span><br>        <span class="hljs-keyword">return</span> (u.name, u.age);<br>    &#125;<br><br>    <span class="hljs-comment">// 辅助函数：查看链上 user 数据</span><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUser</span><span class="hljs-params">()</span> <span class="hljs-title">external</span> <span class="hljs-title">view</span> <span class="hljs-title">returns</span> <span class="hljs-params">(<span class="hljs-keyword">string</span> memory, <span class="hljs-keyword">uint</span>)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> (user.name, user.age);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="🧪-Remix-实验步骤（强烈建议你自己动手试）"><a href="#🧪-Remix-实验步骤（强烈建议你自己动手试）" class="headerlink" title="🧪 Remix 实验步骤（强烈建议你自己动手试）"></a>🧪 Remix 实验步骤（强烈建议你自己动手试）</h2><p>第一步：部署合约</p>
<p>点击 Deploy。</p>
<p>初始状态：</p>
<p>getUser() → (“Alice”, 18)<br><img src="/2025/11/12/27669/2.png"></p>
<p>第二步：调用 changeMemory()<br>返回值 → (“Alice”, 200)</p>
<p>再调用：</p>
<p>getUser() → (“Alice”, 18)<br><img src="/2025/11/12/27669/3.png"></p>
<p>🟡 结论：<br>memory 创建了副本，只在函数里改动，不影响链上数据。</p>
<p>第三步：调用 changeStorage()<br>调用成功。</p>
<p>再查看：</p>
<p>getUser() → (“Alice”, 99)<br><img src="/2025/11/12/27669/1.png"></p>
<p>🟢 结论：<br>storage 修改了链上数据，永久保存。</p>
<p>第四步：测试 showCalldata</p>
<p>参数输入：</p>
<p>[“Bob”, 30]</p>
<p>返回结果：</p>
<p>(“Bob”, 30)<br><img src="/2025/11/12/27669/4.png"></p>
<p>尝试在函数中修改 u.age 会报错（calldata 是只读的）。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>点击changeMemory，返回[call]from: 0x5B38Da6a701c568545dCfcB03FcB875f56beddC4to: StorageVsMemory.changeMemory()data: 0x92e…32b11 ，decoded_output等于{<br>	“0”: “tuple(string,uint256): Alice,200”<br>}</p>
<p>✅ 太好了！你观察到的这一行结果，正是 Solidity 在 Remix 中返回的 <strong>memory 副本结果</strong>。<br>我们来详细拆解一下它的意义，让你彻底理解背后的逻辑。</p>
<h2 id="🧩-你看到的内容解析"><a href="#🧩-你看到的内容解析" class="headerlink" title="🧩 你看到的内容解析"></a>🧩 你看到的内容解析</h2><figure class="highlight maxima"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs maxima">[call]<br>from: <span class="hljs-number">0x5B38Da6a701c568545dCfcB03FcB875f56beddC4</span><br>to: StorageVsMemory.changeMemory()<br>data: <span class="hljs-number">0x92e</span>...<span class="hljs-number">32b11</span><br>decoded_output:<br>&#123;<br>    <span class="hljs-string">&quot;0&quot;</span>: <span class="hljs-string">&quot;tuple(string,uint256): Alice,200&quot;</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>逐项解释如下👇</p>
<p>| 字段                 | 含义                                       |<br>| <strong>from</strong>           | 你的账户地址（msg.sender）                       |<br>| <strong>to</strong>             | 调用的合约函数 <code>StorageVsMemory.changeMemory()</code> |<br>| <strong>data</strong>           | 编译后的函数选择器 + ABI 编码参数（十六进制形式）             |<br>| <strong>decoded_output</strong> | Remix 自动解码的返回值结果                         |</p>
<h2 id="🧠-decoded-output-详解"><a href="#🧠-decoded-output-详解" class="headerlink" title="🧠 decoded_output 详解"></a>🧠 decoded_output 详解</h2><figure class="highlight scss"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scss">&quot;<span class="hljs-built_in">tuple</span>(string,uint256): Alice,<span class="hljs-number">200</span><span class="hljs-string">&quot;</span><br></code></pre></div></td></tr></table></figure>

<p>这一句表示：</p>
<ul>
<li><p>函数返回了一个 <strong>结构体（tuple）</strong>；</p>
</li>
<li><p>结构体的类型为 <code>(string,uint256)</code>；</p>
</li>
<li><p>对应值是：</p>
<ul>
<li><code>name = &quot;Alice&quot;</code></li>
<li><code>age = 200</code></li>
</ul>
</li>
</ul>
<p>也就是说：</p>
<blockquote>
<p>你调用 <code>changeMemory()</code>，函数复制了 <code>user</code>（Alice,18）到 <code>memory</code> 中；<br>然后把副本的 <code>age</code> 改成了 200；<br>最后返回这个修改后的 <strong>副本</strong>。</p>
</blockquote>
<p>但这只是返回值，<strong>不会影响区块链上真正的存储内容</strong>。</p>
<h2 id="🧪-验证这个结论"><a href="#🧪-验证这个结论" class="headerlink" title="🧪 验证这个结论"></a>🧪 验证这个结论</h2><p>立刻再调用：</p>
<figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">getUser</span><span class="hljs-params">()</span></span><br></code></pre></div></td></tr></table></figure>

<p>你会看到：</p>
<figure class="highlight clojure"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs clojure">(<span class="hljs-string">&quot;Alice&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-number">18</span>)<br></code></pre></div></td></tr></table></figure>

<p>说明：</p>
<blockquote>
<p>链上的原始数据 (<code>storage</code>) 并没有被修改。<br><code>memory</code> 只是函数执行时的一份临时副本。</p>
</blockquote>
<h2 id="🔬-延伸理解：为什么要区分-storage-memory？"><a href="#🔬-延伸理解：为什么要区分-storage-memory？" class="headerlink" title="🔬 延伸理解：为什么要区分 storage &#x2F; memory？"></a>🔬 延伸理解：为什么要区分 storage &#x2F; memory？</h2><p>| 场景                  | 推荐使用     | 原因           |<br>| 改状态变量（如余额、所有权）      | storage  | 要永久保存        |<br>| 函数内计算或复制数据          | memory   | 快、便宜         |<br>| 只读外部参数（如外部调用传入的大数组） | calldata | 最省 gas，防止误修改 |</p>
<p>💡 <strong>总结一句话：</strong></p>
<blockquote>
<p><code>storage</code> 是链上房子（改了永久变），<br><code>memory</code> 是临时拍的照片（改了不影响原图），<br><code>calldata</code> 是别人发来的快照（你连编辑都不行）。</p>
</blockquote>
<p>是否想继续做第二个实验：<br>👉「数组版对比：在 storage &#x2F; memory 中修改 uint[] 数组」<br>你可以清楚看到引用型变量的差异（尤其是 push、pop 操作的行为）。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>问题一，这个代码指定的编译器是 pragma solidity ^0.8.24;<br>但我编译选择的编译器是0.8.31，于是编译遇到了一些bug</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs livecodeserver">call <span class="hljs-built_in">to</span> StorageVsMemory.changeMemory errored: Error occurred: invalid opcode.<br><br>invalid opcode<br>	<br>	The execution might have thrown OR <span class="hljs-keyword">the</span> EVM <span class="hljs-built_in">version</span> used <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> selected environment is <span class="hljs-keyword">not</span> compatible <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> compiler EVM <span class="hljs-built_in">version</span>.<br><br>If <span class="hljs-keyword">the</span> transaction failed <span class="hljs-keyword">for</span> <span class="hljs-keyword">not</span> having enough gas, <span class="hljs-keyword">try</span> increasing <span class="hljs-keyword">the</span> gas limit gently.<br></code></pre></div></td></tr></table></figure>

<p>不同的编译器有什么影响？在真实工作的时候应该选哪个编译器？</p>
<p>非常好的问题 👏👏<br>这其实是 Solidity 开发里一个<strong>非常重要、且经常让初学者困惑</strong>的点。<br>你看到的错误：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs livecodeserver">invalid opcode<br>The execution might have thrown OR <span class="hljs-keyword">the</span> EVM <span class="hljs-built_in">version</span> used <span class="hljs-keyword">by</span> <span class="hljs-keyword">the</span> selected environment is <span class="hljs-keyword">not</span> compatible <span class="hljs-keyword">with</span> <span class="hljs-keyword">the</span> compiler EVM <span class="hljs-built_in">version</span>.<br></code></pre></div></td></tr></table></figure>

<p>不是你的代码写错，而是——<strong>编译器版本与执行环境不匹配</strong>导致的。<br>下面我一步步帮你理清楚。</p>
<h2 id="🧩-一、pragma-指令是什么意思？"><a href="#🧩-一、pragma-指令是什么意思？" class="headerlink" title="🧩 一、pragma 指令是什么意思？"></a>🧩 一、pragma 指令是什么意思？</h2><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">pragma solidity ^0.8.24;<br></code></pre></div></td></tr></table></figure>

<p>这一句的意思是：</p>
<blockquote>
<p>“本合约可以在 Solidity 0.8.24 及以上版本（但小于 0.9.0）编译。”</p>
</blockquote>
<p>⚠️ 也就是说：</p>
<ul>
<li>✅ 允许 <code>0.8.24</code>, <code>0.8.25</code>, <code>0.8.30</code>, <code>0.8.31</code></li>
<li>❌ 不允许 <code>0.9.x</code> 或更低的 <code>0.8.0</code></li>
</ul>
<p>所以你的 <code>0.8.31</code> 是合法的。<br>但为什么还是报错？问题不在 pragma，而在<strong>执行环境的 EVM 配置</strong>。</p>
<h2 id="⚙️-二、编译器版本与-EVM-版本的关系"><a href="#⚙️-二、编译器版本与-EVM-版本的关系" class="headerlink" title="⚙️ 二、编译器版本与 EVM 版本的关系"></a>⚙️ 二、编译器版本与 EVM 版本的关系</h2><p>Solidity 是高级语言，编译后会生成 EVM 字节码（Ethereum Virtual Machine code）。<br>不同 Solidity 版本编译出的指令集略有不同。</p>
<p>例如：</p>
<ul>
<li><p>Solidity 0.8.20 引入了新的 <strong>PUSH0</strong> 指令（EIP-3855）。<br>👉 某些旧的 EVM 环境（如 Remix VM old 或 Ganache old）<strong>不支持 PUSH0</strong>。</p>
</li>
<li><p>这时运行时就会出现：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ebnf"><span class="hljs-attribute">invalid opcode</span><br></code></pre></div></td></tr></table></figure>

<p>因为旧的虚拟机根本不认识 PUSH0 这个新指令。</p>
</li>
</ul>
<h2 id="🧪-三、解决方案"><a href="#🧪-三、解决方案" class="headerlink" title="🧪 三、解决方案"></a>🧪 三、解决方案</h2><h3 id="✅-方案-1：升级-EVM-环境（推荐）"><a href="#✅-方案-1：升级-EVM-环境（推荐）" class="headerlink" title="✅ 方案 1：升级 EVM 环境（推荐）"></a>✅ 方案 1：升级 EVM 环境（推荐）</h3><p>在 Remix 右上角：</p>
<blockquote>
<p>“Environment” → 选择 <strong>Remix VM (Shanghai)</strong> 或更高版本。</p>
</blockquote>
<p>确保支持最新 EVM（建议至少 Shanghai 或 Cancun）。</p>
<h3 id="✅-方案-2：降低编译器版本"><a href="#✅-方案-2：降低编译器版本" class="headerlink" title="✅ 方案 2：降低编译器版本"></a>✅ 方案 2：降低编译器版本</h3><p>如果你的 EVM 环境太旧（例如一些私链、测试框架），<br>可以改成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">pragma solidity ^0.8.19;<br></code></pre></div></td></tr></table></figure>

<p>然后在 Remix 选择 <strong>Compiler 0.8.19</strong>。<br>这时编译器会生成旧格式的字节码，旧 EVM 也能跑。</p>
<h3 id="✅-方案-3：生产环境最佳实践"><a href="#✅-方案-3：生产环境最佳实践" class="headerlink" title="✅ 方案 3：生产环境最佳实践"></a>✅ 方案 3：生产环境最佳实践</h3><p>| 场景          | 建议做法                                                   |<br>| 学习 &#x2F; 测试     | 用最新稳定版（例如 0.8.31）+ Remix Shanghai                      |<br>| 公司项目 &#x2F; 审计项目 | <strong>锁定具体版本</strong>（如 <code>pragma solidity 0.8.21;</code>），不要用 <code>^</code>，避免升级破坏 |<br>| 开源项目        | 在 README 中注明编译器版本（如：“Tested with Solidity 0.8.24”）     |</p>
<blockquote>
<p>💡 原因：不同版本在 gas、opcode、内置函数（例如 <code>abi.encodeCall</code>）上会有差异，<br>在审计和部署时保持一致的编译器是非常重要的。</p>
</blockquote>
<h2 id="🧠-四、工作中选编译器的标准答案"><a href="#🧠-四、工作中选编译器的标准答案" class="headerlink" title="🧠 四、工作中选编译器的标准答案"></a>🧠 四、工作中选编译器的标准答案</h2><p>| 场景      | 编译器版本选择                                  |<br>| 新项目     | <strong>最新稳定版（≥0.8.20）</strong>，支持 PUSH0，节省 gas       |<br>| 审计旧合约   | 使用原项目指定版本（完全一致）                          |<br>| 部署到主网   | 锁定版本号（如 <code>pragma solidity 0.8.21;</code>）       |<br>| 教学 &#x2F; 实验 | 最新版（如 0.8.31）即可，但 EVM 环境要匹配 Shanghai 或更高 |</p>
<h2 id="✅-总结一句话："><a href="#✅-总结一句话：" class="headerlink" title="✅ 总结一句话："></a>✅ 总结一句话：</h2><blockquote>
<p>“invalid opcode” 通常不是代码错，而是 <strong>编译器版本 &gt; EVM 环境版本</strong> 导致的兼容性问题。<br>在真实工作中，应 <strong>锁定特定 Solidity 版本</strong>，并确保 <strong>EVM 支持相同指令集</strong>。</p>
</blockquote>
<p>如果你想，我可以帮你写一段短代码：<br>👉 在不同编译器版本下展示 “PUSH0” 的差异（即为什么 0.8.20+ 编译出的字节码在旧 EVM 报 invalid opcode）。<br>要我展示一下这个对比实验吗？</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Web3/">Web3</a>
                    
                  </div>
                
              </div>
              
                
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/11/12/5541.html">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">remix编译运行solidity5</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/11/11/45492.html">
                        <span class="hidden-mobile">remix编译运行solidity3</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


            

                
                  <a id="scroll-top-button" href="#" role="button">
                    <i class="iconfont icon-arrowup" aria-hidden="true"></i>
                  </a>
                  

                    

                          
      </main>

      <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://whale3070.github.io/" target="_blank" rel="nofollow noopener"><span>Whale3070</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->




  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
  <script src="/pagefind/pagefind-ui.js"></script>
  <style>
    /* 搜索框配色适配 */
    #search { margin-top: 2rem; }
    [data-user-color-scheme='dark'] .pagefind-ui {
      --pagefind-ui-primary: #eeeeee;
      --pagefind-ui-text: #eeeeee;
      --pagefind-ui-background: #151515;
      --pagefind-ui-border: #333;
    }
  </style>
    </body>

  </html>