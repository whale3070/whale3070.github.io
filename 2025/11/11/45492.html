

  <!DOCTYPE html>
  <html lang="zh-CN" data-default-color-scheme=&#34;dark&#34; >
  <style>
    .text1
    {
    text-shadow: 0px 0px 2px #f2f3f2;
    }
    </style>

  

<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/null">
  <link rel="icon" type="image/png" href="/null">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>remix编译运行solidity3 - whale3070&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"192.168.126.129","root":"/","version":"1.8.7","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 7.3.0"></head>


    <body>
      <header style="height: 70vh;">
        <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>InfoSec learning</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/search/">
                <i class="iconfont icon-search"></i>
                搜索
              </a>
            </li>
          
        
        
        
          
        
      </ul>
    </div>
  </div>
</nav>

          <div class="banner" id="banner" false
            style="background: url('/img/default.png') no-repeat center center;
              background-size: cover;">
              <div class="full-bg-img">
                <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
                  <div class="page-header text-center fade-in-up">
                    <span class="h2 text1" id="subtitle" title="remix编译运行solidity3">
                      
                        remix编译运行solidity3
                      
                    </span>
        
                    
                      <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2025-11-11 12:10" pubdate>
        2025年11月11日 中午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      43
       分钟
    </span>
  

  
  
</div>

                    
                  </div>
                    
                  </div>
                  
                </div>
              </div>
          </div>
      </header>

      <main>
        
          

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" data-pagefind-body>
            <!-- SEO header -->
            <h1 style="display: none">remix编译运行solidity3</h1>
            
            <div class="markdown-body">
              <h1 id="calldata相关的问题"><a href="#calldata相关的问题" class="headerlink" title="calldata相关的问题"></a>calldata相关的问题</h1><p>这两天学习了一些小合约，尝试了calldata，但还没有用过storage和memory。在deployed contracts中，callbyinterface的下方有calldata，点击copy calldata to clipboard，就得到了0x469883d10000000000000000000000003328358128832a260c76a4141e19e2a943cd4b6d。但我不知道这个calldata是什么意思</p>
<p>下面我给你一个<strong>专业、体系化、逐字段拆解的解释</strong>，让你完全理解：</p>
<ul>
<li>什么是 calldata</li>
<li>为什么 Remix 会生成这串十六进制</li>
<li>这串 calldata 每一部分代表什么</li>
<li>什么是“4 字节函数选择器 + ABI 编码参数”</li>
</ul>
<p>你未来做 Auditor 必须吃透这一点。</p>
<h2 id="一、你看到的这串是什么？"><a href="#一、你看到的这串是什么？" class="headerlink" title="一、你看到的这串是什么？"></a>一、你看到的这串是什么？</h2><p>你复制到的这段十六进制：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli">0x469883d10000000000000000000000003328358128832a260c76a4141e19e2a943<span class="hljs-keyword">cd</span>4b6d<br></code></pre></div></td></tr></table></figure>

<p>这就是：</p>
<p><strong>传入给函数 <code>callByInterface(address)</code> 的 ABI-encoded calldata（函数选择器 + 参数编码）</strong></p>
<p>也就是说：<br>这是 EVM 在进行一次跨合约调用时“实际发送给合约的原始字节消息”。</p>
<p>Solidity（以及 Remix）把它用十六进制（hex）表示出来。</p>
<h2 id="二、为什么会有这段-calldata？"><a href="#二、为什么会有这段-calldata？" class="headerlink" title="二、为什么会有这段 calldata？"></a>二、为什么会有这段 calldata？</h2><p>当你按下 “callByInterface” 按钮时，Remix 必须以 “低级格式” 把真正的数据发送给合约。</p>
<p>你看到的就是：</p>
<p><strong>接口函数调用的底层表现</strong></p>
<p>这就是“你使用 interface 调用，但底层仍然是以 calldata 字节形式发送 CALL”。<br>这正是为什么 interface 是“高层调用”，但本质仍是低级 CALL。</p>
<h2 id="三、我们来逐字段拆解你的-calldata"><a href="#三、我们来逐字段拆解你的-calldata" class="headerlink" title="三、我们来逐字段拆解你的 calldata"></a>三、我们来逐字段拆解你的 calldata</h2><p>你这段 calldata：</p>
<figure class="highlight llvm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs llvm"><span class="hljs-number">0</span><span class="hljs-keyword">x</span><br><span class="hljs-number">469883</span>d<span class="hljs-number">1</span><br><span class="hljs-number">0000000000000000000000000000000000000000000000000000000000000000</span><br><span class="hljs-number">3328358128832</span>a<span class="hljs-number">260</span><span class="hljs-keyword">c</span><span class="hljs-number">76</span>a<span class="hljs-number">4141e19</span>e<span class="hljs-number">2</span>a<span class="hljs-number">943</span>cd<span class="hljs-number">4</span>b<span class="hljs-number">6</span>d<br></code></pre></div></td></tr></table></figure>

<p>我们拆成两部分：</p>
<h4 id="第一部分（前-4-字节）：函数选择器（function-selector）"><a href="#第一部分（前-4-字节）：函数选择器（function-selector）" class="headerlink" title="第一部分（前 4 字节）：函数选择器（function selector）"></a>第一部分（前 4 字节）：函数选择器（function selector）</h4><figure class="highlight armasm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs armasm"><span class="hljs-number">469883</span><span class="hljs-built_in">d1</span><br></code></pre></div></td></tr></table></figure>

<p>这是：</p>
<figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">keccak256</span><span class="hljs-params">(<span class="hljs-string">&quot;callByInterface(address)&quot;</span>)</span></span><span class="hljs-selector-attr">[0:4]</span><br></code></pre></div></td></tr></table></figure>

<p>EVM 用这 4 个字节决定“我要调用哪个函数”。</p>
<p>你可以自己验证：</p>
<p>如果你在 Remix console 输入：</p>
<figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">web3<span class="hljs-selector-class">.utils</span><span class="hljs-selector-class">.keccak256</span>(<span class="hljs-string">&quot;callByInterface(address)&quot;</span>)<br></code></pre></div></td></tr></table></figure>

<p>会得到：</p>
<figure class="highlight erlang"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs erlang"><span class="hljs-number">0</span>x469883d143c9c2ab...<br></code></pre></div></td></tr></table></figure>

<p>前 4 字节就是：</p>
<figure class="highlight dns"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs dns"><span class="hljs-number">0</span>x<span class="hljs-number">469883d1</span><br></code></pre></div></td></tr></table></figure>


<h4 id="第二部分（32-字节）：参数-address-的-ABI-编码"><a href="#第二部分（32-字节）：参数-address-的-ABI-编码" class="headerlink" title="第二部分（32 字节）：参数 address 的 ABI 编码"></a>第二部分（32 字节）：参数 address 的 ABI 编码</h4><p>Solidity ABI 规定：</p>
<ul>
<li>所有参数都必须占 <strong>32 字节</strong>（256 bit）</li>
<li>address 20 字节 → 左侧补 12 字节 0</li>
</ul>
<p>你传入的地址是：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli">0x3328358128832a260c76a4141e19e2a943<span class="hljs-keyword">cd</span>4b6d<br></code></pre></div></td></tr></table></figure>

<p>ABI 编码为：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs jboss-cli">0000000000000000000000003328358128832a260c76a4141e19e2a943<span class="hljs-keyword">cd</span>4b6d<br></code></pre></div></td></tr></table></figure>

<p>组合起来就是完整的 calldata：</p>
<figure class="highlight llvm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs llvm"><span class="hljs-number">0</span><span class="hljs-keyword">x</span><br><span class="hljs-number">469883</span>d<span class="hljs-number">1</span>                                ← 函数选择器<br><span class="hljs-number">0000000000000000000000003328358128832</span>a<span class="hljs-number">260</span><span class="hljs-keyword">c</span><span class="hljs-number">76</span>a<span class="hljs-number">4141e19</span>e<span class="hljs-number">2</span>a<span class="hljs-number">943</span>cd<span class="hljs-number">4</span>b<span class="hljs-number">6</span>d  ← 参数<br></code></pre></div></td></tr></table></figure>

<p>你现在完全能看懂了。</p>
<h2 id="四、为什么-storage-memory-calldata-重要？"><a href="#四、为什么-storage-memory-calldata-重要？" class="headerlink" title="四、为什么 storage &#x2F; memory &#x2F; calldata 重要？"></a>四、为什么 storage &#x2F; memory &#x2F; calldata 重要？</h2><p>这里你第一次看到“真实的 calldata”。</p>
<p>在 Solidity 中：</p>
<p>| 名称       | 存储位置       | 生命周期     | 用途             |<br>| storage  | 永久存储（链上）   | 交易之间持久存在 | 状态变量           |<br>| memory   | 临时（函数执行期间） | 调用结束后释放  | 局部变量、数组        |<br>| calldata | 外部调用输入数据   | 只读、不可修改  | 函数参数（external） |</p>
<p>你看到的十六进制就是：</p>
<p><strong>callByInterface(address) 的 calldata 区域内容</strong></p>
<p>这些数据从外部发送到合约，被 EVM 加载到 calldata。</p>
<h2 id="五、你现在应该掌握的核心概念（Auditor-必备）"><a href="#五、你现在应该掌握的核心概念（Auditor-必备）" class="headerlink" title="五、你现在应该掌握的核心概念（Auditor 必备）"></a>五、你现在应该掌握的核心概念（Auditor 必备）</h2><p>你在学习合约早期阶段，看见 calldata 十六进制是非常好的信号，说明你开始深入 EVM 层。</p>
<p>请记住这几个重点：</p>
<ol>
<li><strong>所有跨合约调用最终都以 calldata 字节方式在 EVM 中执行</strong></li>
<li><strong>函数选择器是 keccak256 的前 4 字节</strong></li>
<li><strong>所有参数都编码成 32 字节（address 也要 padding）</strong></li>
<li><strong>interface 调用只是语法糖，底层仍是这种字节消息</strong></li>
<li><strong>call 调用需要手动写 abi.encode → 就是生成这样的字节</strong></li>
</ol>
<p>当你看到 calldata，你就能“读懂”调用发生了什么，这就是未来审计的核心能力之一。</p>
<h1 id="mapping相关的问题"><a href="#mapping相关的问题" class="headerlink" title="mapping相关的问题"></a>mapping相关的问题</h1><p>下面我给你一份<strong>专业、清晰、完全从 Solidity 设计哲学 + 业务场景 + 安全需求</strong>出发的解释，让你彻底理解：</p>
<ul>
<li>为什么 Solidity 需要 mapping</li>
<li>它为什么类似 Python 字典但又完全不同</li>
<li>为什么智能合约大量使用“单映射”和“双重映射”</li>
<li>它的底层结构是什么</li>
</ul>
<p>这部分是你成为 Junior Auditor &#x2F; Developer 的基础核心能力。</p>
<h2 id="一、mapping-为什么看起来像-Python-字典？"><a href="#一、mapping-为什么看起来像-Python-字典？" class="headerlink" title="一、mapping 为什么看起来像 Python 字典？"></a>一、mapping 为什么看起来像 Python 字典？</h2><p>从表面上看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">mapping(address =&gt; uint) balances;<br></code></pre></div></td></tr></table></figure>

<p>就像 Python：</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python">balances = &#123; <span class="hljs-string">&quot;0xabc&quot;</span>: <span class="hljs-number">1000</span> &#125;<br></code></pre></div></td></tr></table></figure>

<p>你看到的“像字典”是正常反应，因为两者都表达：</p>
<p><strong>用某个 key 查找某个 value 的数据结构。</strong></p>
<p>但是重点来了：</p>
<p><strong>mapping 的行为、限制、底层结构与 Python 字典完全不同。</strong></p>
<p>mapping 不是字典，而是 <strong>区块链上为“定址查找”专门设计的哈希结构</strong>。</p>
<h2 id="二、为什么-Solidity-需要-mapping？（核心原因）"><a href="#二、为什么-Solidity-需要-mapping？（核心原因）" class="headerlink" title="二、为什么 Solidity 需要 mapping？（核心原因）"></a>二、为什么 Solidity 需要 mapping？（核心原因）</h2><p>因为链上有几个独特需求：</p>
<h6 id="1）区块链无法遍历状态-——-mapping-完美符合这一点"><a href="#1）区块链无法遍历状态-——-mapping-完美符合这一点" class="headerlink" title="1）区块链无法遍历状态 —— mapping 完美符合这一点"></a>1）区块链无法遍历状态 —— mapping 完美符合这一点</h6><p>链上状态必须：</p>
<ul>
<li>明确定址（通过 key 直接找到数据）</li>
<li>无法遍历（增加安全性和可扩展性）</li>
<li>永远以 O(1) 查找</li>
</ul>
<p>mapping 恰好满足：</p>
<figure class="highlight scss"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs scss">balances<span class="hljs-selector-attr">[user]</span> → <span class="hljs-built_in">O</span>(<span class="hljs-number">1</span>)<br></code></pre></div></td></tr></table></figure>

<p>没有数组那种越界风险，也不会出现 Python 字典那种 rehash 行为。</p>
<p><strong>mapping &#x3D; 区块链上最安全、可预测、可扩展的键值结构。</strong></p>
<h6 id="2）mapping-不可遍历（by-design），非常重要"><a href="#2）mapping-不可遍历（by-design），非常重要" class="headerlink" title="2）mapping 不可遍历（by design），非常重要"></a>2）mapping 不可遍历（by design），非常重要</h6><p>新手会觉得这是缺点：</p>
<p>“为什么 mapping 不能遍历？好奇怪。”</p>
<p>但这是区块链的必然设计：</p>
<ul>
<li>遍历 &#x3D; 线性扫描 &#x3D; 随着用户数量增长，gas 会爆炸</li>
<li>链上合约必须保证 gas 可控</li>
<li>所以 EVM 禁止“自动列出所有 key”</li>
</ul>
<p>这就是为什么：</p>
<p><strong>mapping 是无边界结构，理论上可以放无限用户，而 gas 始终稳定。</strong></p>
<h6 id="3）mapping-更安全"><a href="#3）mapping-更安全" class="headerlink" title="3）mapping 更安全"></a>3）mapping 更安全</h6><p>如果链上允许地址遍历，会导致严重隐私泄漏与攻击可能：</p>
<ul>
<li>所有用户地址</li>
<li>所有用户余额</li>
<li>所有用户状态</li>
<li>全部可被恶意代码扫描</li>
</ul>
<p>mapping 不可遍历 → 避免这种风险。</p>
<h6 id="4）mapping-是-EVM-原生数据结构（gas-最低）"><a href="#4）mapping-是-EVM-原生数据结构（gas-最低）" class="headerlink" title="4）mapping 是 EVM 原生数据结构（gas 最低）"></a>4）mapping 是 EVM 原生数据结构（gas 最低）</h6><p>mapping 的存储模型是：</p>
<figure class="highlight ini"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ini"><span class="hljs-attr">slot</span> = keccak256( concat(key, mapping_slot) )<br></code></pre></div></td></tr></table></figure>

<p>这是 EVM 原生支持的模式，读取和写入都极快。</p>
<p>相比之下：</p>
<ul>
<li>array[0], array[1] 需要边界检查</li>
<li>struct 需要固定 slot 排布</li>
<li>dictionary（Python）有大量 runtime 逻辑</li>
</ul>
<p>mapping 是 EVM 为智能合约量身定做的键值结构。</p>
<h2 id="三、为什么要用-mapping-来做“一重映射”和“双重映射”？"><a href="#三、为什么要用-mapping-来做“一重映射”和“双重映射”？" class="headerlink" title="三、为什么要用 mapping 来做“一重映射”和“双重映射”？"></a>三、为什么要用 mapping 来做“一重映射”和“双重映射”？</h2><p>初学者一般在 NFT、Token、权限管理时会看到这种写法：</p>
<figure class="highlight arcade"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arcade">mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> uint) balances;<br>mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> bool)) isApproved;<br></code></pre></div></td></tr></table></figure>

<p>你可能会想：</p>
<p>“为什么这么复杂？真的需要吗？”</p>
<p>答案是：<br><strong>链上业务天然需要映射关系。</strong></p>
<p>我们看常见场景。</p>
<h4 id="1）Token-余额（ERC20）"><a href="#1）Token-余额（ERC20）" class="headerlink" title="1）Token 余额（ERC20）"></a>1）Token 余额（ERC20）</h4><figure class="highlight abnf"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs abnf">mapping(address <span class="hljs-operator">=</span>&gt; uint256) balances<span class="hljs-comment">;</span><br></code></pre></div></td></tr></table></figure>

<p>每个用户都有余额，这就是典型的“一对一关系”：</p>
<figure class="highlight"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs">用户 → 余额<br></code></pre></div></td></tr></table></figure>


<h4 id="2）授权关系（ERC20-allowance）"><a href="#2）授权关系（ERC20-allowance）" class="headerlink" title="2）授权关系（ERC20 allowance）"></a>2）授权关系（ERC20 allowance）</h4><figure class="highlight arcade"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arcade">mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> uint256)) allowance;<br></code></pre></div></td></tr></table></figure>

<p>意思是：</p>
<figure class="highlight nginx"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs nginx"><span class="hljs-attribute">owner</span> → spender → 可花费金额<br></code></pre></div></td></tr></table></figure>

<p>这是“双重映射”。</p>
<p>为什么不是数组？<br>因为：</p>
<ul>
<li>每个用户可能授权给多个 DEX、钱包</li>
<li>关系不可能预先固定</li>
<li>也无法遍历所有用户</li>
<li>必须 O(1) 查找</li>
</ul>
<p>ERC20、ERC721、ERC1155 都依赖双重映射。</p>
<h4 id="3）关注关系-好友关系（你做过的小合约）"><a href="#3）关注关系-好友关系（你做过的小合约）" class="headerlink" title="3）关注关系 &#x2F; 好友关系（你做过的小合约）"></a>3）关注关系 &#x2F; 好友关系（你做过的小合约）</h4><figure class="highlight arcade"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arcade">mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> bool)) isFollowing;<br></code></pre></div></td></tr></table></figure>

<p>表示：</p>
<figure class="highlight css"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs css"><span class="hljs-selector-tag">A</span> 是否关注 <span class="hljs-selector-tag">B</span><br></code></pre></div></td></tr></table></figure>

<p>社交、GameFi、DAO 里非常常见。</p>
<h4 id="4）访问权限（AccessControl）"><a href="#4）访问权限（AccessControl）" class="headerlink" title="4）访问权限（AccessControl）"></a>4）访问权限（AccessControl）</h4><figure class="highlight arcade"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arcade">mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> bool) isAdmin;<br>mapping(<span class="hljs-function"><span class="hljs-params">bytes32</span> =&gt;</span> mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> bool)) roles;<br></code></pre></div></td></tr></table></figure>

<p>安全控制必须做到：</p>
<ul>
<li>O(1) 判断权限</li>
<li>不可被遍历攻击</li>
<li>不可被猜测结构</li>
</ul>
<p>mapping 是最安全方法。</p>
<h2 id="四、mapping-与-Python-字典的本质区别（审计特别重要）"><a href="#四、mapping-与-Python-字典的本质区别（审计特别重要）" class="headerlink" title="四、mapping 与 Python 字典的本质区别（审计特别重要）"></a>四、mapping 与 Python 字典的本质区别（审计特别重要）</h2><p>| 项目             | Python dict | Solidity mapping         |<br>| 存储位置           | 内存          | 链上永久存储                   |<br>| 是否可遍历          | 是           | 否                        |<br>| 是否能删除 key      | 可以删除        | delete 不会删除 key，只置 0     |<br>| 是否有长度          | 有 len()     | 无 length                 |<br>| 是否可判断 key 是否存在 | 可以          | 无法判断（默认值 &#x3D; 0）            |<br>| hash 是否可见      | 不可见         | slot &#x3D; keccak(key, slot) |<br>| gas 是否增长       | 不相关         | 必须可预期稳定                  |</p>
<p>结论：</p>
<p><strong>mapping 不是“字典”，而是“不可遍历的链上键值数据库”。</strong></p>
<h2 id="五、你未来会遇到三类常见-mapping-模式（学习重点）"><a href="#五、你未来会遇到三类常见-mapping-模式（学习重点）" class="headerlink" title="五、你未来会遇到三类常见 mapping 模式（学习重点）"></a>五、你未来会遇到三类常见 mapping 模式（学习重点）</h2><h6 id="1）简单映射"><a href="#1）简单映射" class="headerlink" title="1）简单映射"></a>1）简单映射</h6><figure class="highlight abnf"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs abnf">mapping(address <span class="hljs-operator">=</span>&gt; uint) balance<span class="hljs-comment">;</span><br></code></pre></div></td></tr></table></figure>

<h6 id="2）双重映射"><a href="#2）双重映射" class="headerlink" title="2）双重映射"></a>2）双重映射</h6><figure class="highlight arcade"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arcade">mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> bool)) approval;<br></code></pre></div></td></tr></table></figure>

<h6 id="3）结构体映射"><a href="#3）结构体映射" class="headerlink" title="3）结构体映射"></a>3）结构体映射</h6><figure class="highlight abnf"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs abnf">struct User &#123;<br>    uint age<span class="hljs-comment">;</span><br>    address ref<span class="hljs-comment">;</span><br>&#125;<br><br>mapping(address <span class="hljs-operator">=</span>&gt; User) users<span class="hljs-comment">;</span><br></code></pre></div></td></tr></table></figure>

<p>这是最常见的 Web3 数据模式。</p>
<h2 id="六、你什么时候需要-array？什么时候-mapping？"><a href="#六、你什么时候需要-array？什么时候-mapping？" class="headerlink" title="六、你什么时候需要 array？什么时候 mapping？"></a>六、你什么时候需要 array？什么时候 mapping？</h2><p>| 数据结构    | 用途                        |<br>| array   | 有顺序、要遍历、高维度数据结构           |<br>| mapping | 用户数量不定、无法遍历、安全要求高、O(1) 查找 |</p>
<p>例子：</p>
<ul>
<li>NFT 全部 tokenId：array</li>
<li>用户余额：mapping</li>
<li>DAO 成员列表：array + mapping（组合）</li>
<li>谁授权了谁：mapping</li>
</ul>
<p>mapping 是链上业务的核心。</p>
<h2 id="七、总结（面试级别回答）"><a href="#七、总结（面试级别回答）" class="headerlink" title="七、总结（面试级别回答）"></a>七、总结（面试级别回答）</h2><p>你可以这样总结：</p>
<p>Solidity 的 mapping 不是 Python 字典，而是链上为不可遍历、O(1) 查找设计的特殊键值存储结构。它无法遍历、没有长度、所有 key 都有默认值，因此非常安全、节省 gas，适合表示用户余额、授权、权限、关注关系等不可预知规模的数据。双重映射允许表达 owner→spender、user→user 的复杂关系，是智能合约中最常见的数据结构之一。</p>
<p>如果你愿意，我可以继续教你：</p>
<ul>
<li>mapping 在 EVM 的底层存储结构（slot 计算）</li>
<li>写一个双映射的练习合约</li>
<li>写一个 mapping + array 的组合模式（最常见）</li>
<li>编写一个访问控制系统（AccessControl）</li>
</ul>
<p>你想继续哪个方向？</p>
<h1 id="白名单钱包"><a href="#白名单钱包" class="headerlink" title="白名单钱包"></a>白名单钱包</h1><h2 id="whitelistWallet-sol"><a href="#whitelistWallet-sol" class="headerlink" title="whitelistWallet.sol"></a>whitelistWallet.sol</h2><figure class="highlight csharp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs csharp"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span><br>pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.20</span>;<br><br>contract SimpleWallet &#123;<br><br>    <span class="hljs-comment">// 1. 储存每个用户余额</span><br>    mapping(address =&gt; <span class="hljs-built_in">uint</span>) <span class="hljs-keyword">public</span> balances;<br><br>    <span class="hljs-comment">// 2. 白名单</span><br>    mapping(address =&gt; <span class="hljs-built_in">bool</span>) <span class="hljs-keyword">public</span> whitelist;<br><br>    <span class="hljs-comment">// ========== Events ==========</span><br>    <span class="hljs-function"><span class="hljs-keyword">event</span> <span class="hljs-title">Whitelisted</span>(<span class="hljs-params">address indexed user</span>)</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">event</span> <span class="hljs-title">Removed</span>(<span class="hljs-params">address indexed user</span>)</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">event</span> <span class="hljs-title">Deposited</span>(<span class="hljs-params">address indexed user, <span class="hljs-built_in">uint</span> amount</span>)</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">event</span> <span class="hljs-title">Transferred</span>(<span class="hljs-params">address indexed <span class="hljs-keyword">from</span>, address indexed to, <span class="hljs-built_in">uint</span> amount</span>)</span>;<br><br>    <span class="hljs-comment">// ========== Modifier ==========</span><br>    <span class="hljs-function">modifier <span class="hljs-title">onlyWhitelist</span>()</span> &#123;<br>        require(whitelist[msg.sender], <span class="hljs-string">&quot;Not in whitelist&quot;</span>);<br>        _;<br>    &#125;<br><br>    <span class="hljs-comment">// ========== 公共函数 ==========</span><br><br>    <span class="hljs-comment">// 存钱</span><br>    <span class="hljs-function">function <span class="hljs-title">deposit</span>() external payable</span> &#123;<br>        balances[msg.sender] += msg.<span class="hljs-keyword">value</span>;<br>        <span class="hljs-function">emit <span class="hljs-title">Deposited</span>(<span class="hljs-params">msg.sender, msg.<span class="hljs-keyword">value</span></span>)</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 加白名单</span><br>    <span class="hljs-function">function <span class="hljs-title">addWhitelist</span>(<span class="hljs-params">address user</span>) external</span> &#123;<br>        whitelist[user] = <span class="hljs-literal">true</span>;<br>        <span class="hljs-function">emit <span class="hljs-title">Whitelisted</span>(<span class="hljs-params">user</span>)</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 移除白名单</span><br>    <span class="hljs-function">function <span class="hljs-title">removeWhitelist</span>(<span class="hljs-params">address user</span>) external</span> &#123;<br>        whitelist[user] = <span class="hljs-literal">false</span>;<br>        <span class="hljs-function">emit <span class="hljs-title">Removed</span>(<span class="hljs-params">user</span>)</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 转账（仅白名单用户能操作）</span><br>    <span class="hljs-function">function <span class="hljs-title">transferTo</span>(<span class="hljs-params">address to, <span class="hljs-built_in">uint</span> amount</span>) external onlyWhitelist</span> &#123;<br>        require(balances[msg.sender] &gt;= amount, <span class="hljs-string">&quot;Insufficient balance&quot;</span>);<br><br>        balances[msg.sender] -= amount;<br>        balances[to] += amount;<br><br>        <span class="hljs-function">emit <span class="hljs-title">Transferred</span>(<span class="hljs-params">msg.sender, to, amount</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="remix中测试"><a href="#remix中测试" class="headerlink" title="remix中测试"></a>remix中测试</h2><p>第一步，点copy account，复制eth地址<code>0x617F2E2fD72FD9D5503197092aC168c91465E7f2</code><br><img src="/2025/11/11/45492/2.png" srcset="/img/loading.gif"></p>
<p>第二步，把eth地址 <code>0x617F2E2fD72FD9D5503197092aC168c91465E7f2</code> 添加到白名单，如下图所示</p>
<p><img src="/2025/11/11/45492/1.png" srcset="/img/loading.gif"></p>
<p>第三步，试下transfer to功能<br><img src="/2025/11/11/45492/3.png" srcset="/img/loading.gif"><br>上图的意思，就是往这个地址转账</p>
<p>第四步，balance 查看这个地址有多少存款</p>
<p>第五步，试下非白名单地址</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">call <span class="hljs-keyword">to</span> SimpleWallet.balances errored: <span class="hljs-built_in">Error</span> encoding arguments: TypeError: invalid<span class="hljs-built_in"> address </span>(<span class="hljs-attribute">argument</span>=<span class="hljs-string">&quot;address&quot;</span>, <span class="hljs-attribute">value</span>=<span class="hljs-string">&quot;0xa39cd51110598e2277f8122940cdde41cff06b061de260d47d79753c0b64ea9c&quot;</span>, <span class="hljs-attribute">code</span>=INVALID_ARGUMENT, <span class="hljs-attribute">version</span>=6.14.0) (<span class="hljs-attribute">argument</span>=<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-attribute">value</span>=<span class="hljs-string">&quot;0xa39cd51110598e2277f8122940cdde41cff06b061de260d47d79753c0b64ea9c&quot;</span>, <span class="hljs-attribute">code</span>=INVALID_ARGUMENT, <span class="hljs-attribute">version</span>=6.14.0)<br></code></pre></div></td></tr></table></figure>

<h2 id="为什么-Solidity-里叫-modifier（修饰器）？它到底类似什么？"><a href="#为什么-Solidity-里叫-modifier（修饰器）？它到底类似什么？" class="headerlink" title="为什么 Solidity 里叫 modifier（修饰器）？它到底类似什么？"></a><strong>为什么 Solidity 里叫 modifier（修饰器）？它到底类似什么？</strong></h2><p>因为你会 Python &#x2F; JavaScript，所以我用它们的语法帮你建立“类比概念”，让你 100% 理解 modifier 的作用与设计哲学。</p>
<h2 id="一句话本质总结（非常准确）"><a href="#一句话本质总结（非常准确）" class="headerlink" title="一句话本质总结（非常准确）"></a>一句话本质总结（非常准确）</h2><p><strong>Solidity 的 modifier 就相当于：“在函数执行前后，自动插入一段通用逻辑的语法糖”。</strong></p>
<p>它不是函数、不是结构体、不是类，而是：<br><strong>一个可以包裹函数的“逻辑包装器（wrapper）”。</strong></p>
<p>你可以把它理解为下面三者的混合体：</p>
<ul>
<li>Python 的装饰器（@decorator）</li>
<li>Java 的 AOP（面向切面编程）</li>
<li>Web 中间件（middleware）</li>
</ul>
<p>但又不像它们那么自由，范围更窄，只用于函数前置&#x2F;后置检查。</p>
<h2 id="二、你理解不了，是因为-JS-Python-没有完全等价的词"><a href="#二、你理解不了，是因为-JS-Python-没有完全等价的词" class="headerlink" title="二、你理解不了，是因为 JS &#x2F; Python 没有完全等价的词"></a>二、你理解不了，是因为 JS &#x2F; Python 没有完全等价的词</h2><p>Solidity 的 modifier 是 Solidity 语言特有的语法结构，其他语言确实没有完全对应的。</p>
<p>为了帮助你理解，我用三层比喻：</p>
<h2 id="三、比喻-1：modifier-“门卫”"><a href="#三、比喻-1：modifier-“门卫”" class="headerlink" title="三、比喻 1：modifier &#x3D; “门卫”"></a>三、比喻 1：<strong>modifier &#x3D; “门卫”</strong></h2><p>你进公司需要刷卡。</p>
<p>函数执行之前，要先判断“你有没有权限”。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">modifier onlyOwner() &#123;<br>    require(msg.sender == owner, &quot;not owner&quot;);<br>    _;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>这是门卫逻辑。<br><code>_</code> 表示：检查通过后，允许你进入（继续执行函数主体）。</p>
<h2 id="四、比喻-2：modifier-“函数入口处插入一段代码”"><a href="#四、比喻-2：modifier-“函数入口处插入一段代码”" class="headerlink" title="四、比喻 2：modifier &#x3D; “函数入口处插入一段代码”"></a>四、比喻 2：<strong>modifier &#x3D; “函数入口处插入一段代码”</strong></h2><p>有这样一个函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">function withdraw() external &#123;<br>    // 业务逻辑<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>你想让所有 sensitive 函数都“先检查权限”，那你得写：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">require(msg.sender == owner);<br></code></pre></div></td></tr></table></figure>

<p>每个地方都写一遍，可读性非常差。</p>
<p>Solidity 让你把通用逻辑封装成 modifier：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">modifier onlyOwner() &#123;<br>    require(msg.sender == owner);<br>    _;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>然后你可以这样用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">function withdraw() external onlyOwner &#123;<br>    // 业务逻辑<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>你看到的 <code>onlyOwner</code> 就像对函数加了一个“前置检查”。</p>
<h2 id="五、比喻-3：modifier-Python-装饰器-decorator"><a href="#五、比喻-3：modifier-Python-装饰器-decorator" class="headerlink" title="五、比喻 3：modifier &#x3D; Python 装饰器 @decorator"></a>五、比喻 3：<strong>modifier &#x3D; Python 装饰器 @decorator</strong></h2><p>你可能见过：</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">check_login</span>(<span class="hljs-params">func</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user_logged_in:<br>            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;not logged in&quot;</span>)<br>        <span class="hljs-keyword">return</span> func(*args, **kwargs)<br>    <span class="hljs-keyword">return</span> wrapper<br><br><span class="hljs-meta">@check_login</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy</span>():<br>    ...<br></code></pre></div></td></tr></table></figure>

<p>这里的 <code>@check_login</code> 就是在“修饰”函数。</p>
<p>Solidity 的 modifier 作用完全一样，只是写法不同。</p>
<h2 id="六、比喻-4：modifier-Web-中间件（Middleware）"><a href="#六、比喻-4：modifier-Web-中间件（Middleware）" class="headerlink" title="六、比喻 4：modifier &#x3D; Web 中间件（Middleware）"></a>六、比喻 4：<strong>modifier &#x3D; Web 中间件（Middleware）</strong></h2><p>比如 Express.js：</p>
<figure class="highlight javascript"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs javascript">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/admin&#x27;</span>, authMiddleware, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>   res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>&#125;);<br></code></pre></div></td></tr></table></figure>

<p>这里 <code>authMiddleware</code> 会在请求进入路由之前执行身份验证。</p>
<p>Solidity 的 modifier 作用一样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">function adminTask() external onlyOwner &#123;<br>    ...<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>onlyOwner 就像请求进入 adminTask 前必须经过一层“检查”。</p>
<h2 id="七、为什么叫-modifier？"><a href="#七、为什么叫-modifier？" class="headerlink" title="七、为什么叫 modifier？"></a>七、为什么叫 modifier？</h2><p>因为它字面含义就是 “修改函数的执行方式”。</p>
<ul>
<li>它不执行真正的业务逻辑</li>
<li>它只在函数执行前（或后）插入一些检查</li>
<li>它修饰了这个函数的行为</li>
</ul>
<p>所以叫 <strong>修饰器（modifier）</strong>。</p>
<h2 id="八、你要理解的关键点（专业解释）"><a href="#八、你要理解的关键点（专业解释）" class="headerlink" title="八、你要理解的关键点（专业解释）"></a>八、你要理解的关键点（专业解释）</h2><h4 id="modifier-的结构："><a href="#modifier-的结构：" class="headerlink" title="modifier 的结构："></a>modifier 的结构：</h4><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">modifier XXX &#123;<br>    // 前置逻辑<br>    _;<br>    // 后置逻辑（可选）<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p><code>_</code> 表示：<br><strong>把“函数主体”替换到这里。</strong></p>
<p>也就是：</p>
<ul>
<li><code>_</code> 之前的代码 &#x3D; 函数前置逻辑</li>
<li><code>_</code> 之后的代码 &#x3D; 函数后置逻辑</li>
</ul>
<p>绝大多数 modifier 只有前置逻辑（例如权限检查）。</p>
<h2 id="九、最经典例子（你今天写的白名单）"><a href="#九、最经典例子（你今天写的白名单）" class="headerlink" title="九、最经典例子（你今天写的白名单）"></a>九、最经典例子（你今天写的白名单）</h2><p>你写了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">modifier onlyWhitelist() &#123;<br>    require(whitelist[msg.sender], &quot;Not in whitelist&quot;);<br>    _;<br>&#125;<br><br>function transferTo(...) external onlyWhitelist &#123;<br>    ...<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>翻译成自然语言：</p>
<p>“在执行 transferTo 之前，先做一个白名单检查。如果不在白名单，直接 revert；如果在白名单，继续执行。”</p>
<p>这完全符合“门卫”、“装饰器”、“中间件”的概念。</p>
<h2 id="十、总结一句你能记住的话"><a href="#十、总结一句你能记住的话" class="headerlink" title="十、总结一句你能记住的话"></a>十、总结一句你能记住的话</h2><p><strong>modifier 本质上是一个“函数前置&#x2F;后置检查模板”，它会把自己的代码插入到目标函数中，用来写权限控制、输入验证、状态检查等逻辑，是 Solidity 独有的轻量化 AOP 机制。</strong></p>
<h2 id="如果你愿意，我可以继续帮你："><a href="#如果你愿意，我可以继续帮你：" class="headerlink" title="如果你愿意，我可以继续帮你："></a>如果你愿意，我可以继续帮你：</h2><p>A）写一个可视化示例：把 modifier 展开成编译后的完整函数<br>B）写 “多个 modifier 组合” 的例子<br>C）告诉你 modifier 使用不当会产生哪些安全漏洞<br>D）让你练习自己写几个小 modifier（非常有用）</p>
<p>你想继续哪一个？</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/11/12/27669.html">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">remix编译运行solidity4</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/11/11/29045.html">
                        <span class="hidden-mobile">remix编译运行solidity2</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


            

                
                  <a id="scroll-top-button" href="#" role="button">
                    <i class="iconfont icon-arrowup" aria-hidden="true"></i>
                  </a>
                  

                    

                          
      </main>

      <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://whale3070.github.io/" target="_blank" rel="nofollow noopener"><span>Whale3070</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
  <script src="/pagefind/pagefind-ui.js"></script>
  <style>
    /* 搜索框配色适配 */
    #search { margin-top: 2rem; }
    [data-user-color-scheme='dark'] .pagefind-ui {
      --pagefind-ui-primary: #eeeeee;
      --pagefind-ui-text: #eeeeee;
      --pagefind-ui-background: #151515;
      --pagefind-ui-border: #333;
    }
  </style>
    </body>

  </html>