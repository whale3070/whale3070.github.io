

  <!DOCTYPE html>
  <html lang="zh-CN" data-default-color-scheme=&#34;dark&#34; >
  <style>
    .text1
    {
    text-shadow: 0px 0px 2px #f2f3f2;
    }
    </style>

  

<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/null">
  <link rel="icon" type="image/png" href="/null">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>university.alchemy7 - whale3070&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"192.168.126.129","root":"/","version":"1.8.7","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 7.3.0"></head>


    <body>
      <header style="height: 70vh;">
        <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>InfoSec learning</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/search/">
                <i class="iconfont icon-search"></i>
                搜索
              </a>
            </li>
          
        
        
        
          
        
      </ul>
    </div>
  </div>
</nav>

          <div class="banner" id="banner" false
            style="background: url('/img/default.png') no-repeat center center;
              background-size: cover;">
              <div class="full-bg-img">
                <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
                  <div class="page-header text-center fade-in-up">
                    <span class="h2 text1" id="subtitle" title="university.alchemy7">
                      
                        university.alchemy7
                      
                    </span>
        
                    
                      <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2025-12-15 14:29" pubdate>
        2025年12月15日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      4.8k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      63
       分钟
    </span>
  

  
  
</div>

                    
                  </div>
                    
                  </div>
                  
                </div>
              </div>
          </div>
      </header>

      <main>
        
          

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" data-pagefind-body>
            <!-- SEO header -->
            <h1 style="display: none">university.alchemy7</h1>
            
            <div class="markdown-body">
              <h1 id="Your-Goal-Is-Member-你的目标：是否为成员"><a href="#Your-Goal-Is-Member-你的目标：是否为成员" class="headerlink" title="Your Goal: Is Member 你的目标：是否为成员"></a>Your Goal: Is Member 你的目标：是否为成员</h1><p>Create an external, view function called isMember which takes an address and returns a bool indicating whether or not the address is a member.<br>创建一个名为isMember的外部视图函数，该函数接受一个地址&lt;/b1并返回一个布尔值&lt;/b2，用于指示该地址&lt;/b3是否为成员。</p>
<figure class="highlight zephir"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs zephir"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span><br>pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.20</span>;<br><br>contract Contract &#123;<br>    mapping(address =&gt; <span class="hljs-keyword">bool</span>) <span class="hljs-keyword">public</span> members;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addMember</span><span class="hljs-params">(address addr)</span> <span class="hljs-title">external</span> </span>&#123;<br>        <span class="hljs-comment">//如何通过在members映射中该地址对应的数据源位置存储true来实现这一点。</span><br>        members[addr] = <span class="hljs-keyword">true</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isMember</span><span class="hljs-params">(address addr)</span> <span class="hljs-title">external</span> <span class="hljs-title">view</span> <span class="hljs-title">returns</span><span class="hljs-params">(<span class="hljs-keyword">bool</span>)</span> </span>&#123;<br>        <span class="hljs-comment">//该函数接受一个地址&lt;/b1并返回一个布尔值&lt;/b2，用于指示该地址&lt;/b3是否为成员。</span><br>        <span class="hljs-keyword">return</span> members[addr];<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h1 id="Your-Goal-Remove-Member-你的目标：移除成员"><a href="#Your-Goal-Remove-Member-你的目标：移除成员" class="headerlink" title="Your Goal: Remove Member 你的目标：移除成员"></a>Your Goal: Remove Member 你的目标：移除成员</h1><p>Create an external function called removeMember that will take an address and set its corresponding value in the members mapping to false.<br>创建一个名为removeMember的外部函数，该函数将接收一个地址&lt;/b1，并将members映射中与其对应的 value 设置为false。</p>
<figure class="highlight zephir"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs zephir"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span><br>pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.20</span>;<br><br>contract Contract &#123;<br>    mapping(address =&gt; <span class="hljs-keyword">bool</span>) <span class="hljs-keyword">public</span> members;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addMember</span><span class="hljs-params">(address addr)</span> <span class="hljs-title">external</span> </span>&#123;<br>        <span class="hljs-comment">//如何通过在members映射中该地址对应的数据源位置存储true来实现这一点。</span><br>        members[addr] = <span class="hljs-keyword">true</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isMember</span><span class="hljs-params">(address addr)</span> <span class="hljs-title">external</span> <span class="hljs-title">view</span> <span class="hljs-title">returns</span><span class="hljs-params">(<span class="hljs-keyword">bool</span>)</span> </span>&#123;<br>        <span class="hljs-comment">//该函数接受一个地址&lt;/b1并返回一个布尔值&lt;/b2，用于指示该地址&lt;/b3是否为成员。</span><br>        <span class="hljs-keyword">return</span> members[addr];<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeMember</span><span class="hljs-params">(address addr)</span> <span class="hljs-title">external</span> <span class="hljs-title">returns</span><span class="hljs-params">(<span class="hljs-keyword">bool</span>)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> members[addr] = <span class="hljs-keyword">false</span>;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h1 id="什么时候用view，什么时候函数不用view"><a href="#什么时候用view，什么时候函数不用view" class="headerlink" title="什么时候用view，什么时候函数不用view?"></a>什么时候用view，什么时候函数不用view?</h1><p>在 Solidity 中，<code>view</code> 是函数修饰符，核心规则是：**不修改合约状态的函数用 <code>view</code>，修改合约状态的函数不能用 <code>view</code>**。其本质是告诉编译器和链上节点：该函数仅读取数据、无副作用，可避免不必要的Gas消耗（纯本地调用时），同时明确函数的行为边界。</p>
<h3 id="一、先明确：view-函数的核心限制（必须满足以下所有条件）"><a href="#一、先明确：view-函数的核心限制（必须满足以下所有条件）" class="headerlink" title="一、先明确：view 函数的核心限制（必须满足以下所有条件）"></a>一、先明确：<code>view</code> 函数的核心限制（必须满足以下所有条件）</h3><p><code>view</code> 函数承诺<strong>不修改任何合约状态变量</strong>，一旦函数做了以下操作，就不能加 <code>view</code>：</p>
<ol>
<li>不修改状态变量（包括合约自身的状态变量、映射 <code>mapping</code>、数组 <code>array</code> 的元素）；</li>
<li>不触发状态变更（如转账 <code>transfer</code>/<code>send</code>、调用非 <code>view</code>/<code>pure</code> 的外部合约函数）；</li>
<li>不发送交易（如 <code>call&#123;value: ...&#125;</code> 带ETH转账，或调用会修改状态的外部函数）；</li>
<li>不使用 <code>selfdestruct</code>、<code>delegatecall</code> 等会改变合约状态的操作。</li>
</ol>
<p>简单说：<code>view</code> 函数只能“读”，不能“写”。</p>
<h3 id="二、什么时候必须用-view？"><a href="#二、什么时候必须用-view？" class="headerlink" title="二、什么时候必须用 view？"></a>二、什么时候必须用 <code>view</code>？</h3><p>只要函数满足「仅读取数据、不修改任何状态」，就应该加 <code>view</code>（语法允许省略，但不推荐，会降低代码可读性且可能误导调用者）。常见场景：</p>
<h4 id="1-查询合约状态变量（纯读取）"><a href="#1-查询合约状态变量（纯读取）" class="headerlink" title="1. 查询合约状态变量（纯读取）"></a>1. 查询合约状态变量（纯读取）</h4><p>函数仅返回合约中定义的状态变量（如用户余额、配置参数、列表数据），无任何修改操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract Token &#123;<br>    mapping(address =&gt; uint256) public userBalances; // 状态变量：用户余额<br>    uint256 public totalSupply; // 状态变量：总供给<br>    address public owner; // 状态变量：拥有者<br><br>    // 查用户余额：仅读取 mapping，无修改 → 用 view<br>    function getBalance(address _user) public view returns (uint256) &#123;<br>        return userBalances[_user];<br>    &#125;<br><br>    // 查总供给+拥有者：仅读取两个状态变量 → 用 view<br>    function getTokenInfo() public view returns (uint256, address) &#123;<br>        return (totalSupply, owner);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="2-基于状态变量的计算（无副作用）"><a href="#2-基于状态变量的计算（无副作用）" class="headerlink" title="2. 基于状态变量的计算（无副作用）"></a>2. 基于状态变量的计算（无副作用）</h4><p>函数接收参数，结合合约状态做计算后返回结果，但不修改任何状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract MathContract &#123;<br>    uint256 public taxRate = 5; // 税率：5%<br><br>    // 计算税后金额：接收输入+读取税率，仅计算不修改 → 用 view<br>    function calculateAfterTax(uint256 _amount) public view returns (uint256) &#123;<br>        return _amount * (100 - taxRate) / 100;<br>    &#125;<br><br>    // 验证是否为VIP：读取用户余额判断，无修改 → 用 view<br>    function isVIP(address _user) public view returns (bool) &#123;<br>        return userBalances[_user] &gt;= 1000 ether;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="3-读取链上全局变量（无修改）"><a href="#3-读取链上全局变量（无修改）" class="headerlink" title="3. 读取链上全局变量（无修改）"></a>3. 读取链上全局变量（无修改）</h4><p>仅读取 <code>block.number</code>、<code>block.timestamp</code>、<code>msg.sender</code> 等全局变量（不结合状态修改）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract TimeLock &#123;<br>    uint256 public unlockTime;<br><br>    // 检查是否已解锁：读取 unlockTime + block.timestamp，无修改 → 用 view<br>    function isUnlocked() public view returns (bool) &#123;<br>        return block.timestamp &gt;= unlockTime;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="4-调用其他-view-pure-函数（无状态变更）"><a href="#4-调用其他-view-pure-函数（无状态变更）" class="headerlink" title="4. 调用其他 view/pure 函数（无状态变更）"></a>4. 调用其他 <code>view</code>/<code>pure</code> 函数（无状态变更）</h4><p>函数内部仅调用其他 <code>view</code> 或 <code>pure</code> 函数（不触发状态修改）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract Helper &#123;<br>    function add(uint256 a, uint256 b) public pure returns (uint256) &#123;<br>        return a + b;<br>    &#125;<br>&#125;<br><br>contract MyContract &#123;<br>    Helper public helper;<br>    uint256 public base = 100;<br><br>    // 调用 pure 函数+读取状态变量，无修改 → 用 view<br>    function getTotal(uint256 x) public view returns (uint256) &#123;<br>        return helper.add(base, x);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>


<h3 id="三、什么时候不能用-view？"><a href="#三、什么时候不能用-view？" class="headerlink" title="三、什么时候不能用 view？"></a>三、什么时候不能用 <code>view</code>？</h3><p>只要函数会<strong>修改合约状态</strong>或<strong>触发状态变更</strong>，就绝对不能加 <code>view</code>（加了会编译报错，或运行时出现不可预期行为）。常见场景：</p>
<h4 id="1-修改合约状态变量"><a href="#1-修改合约状态变量" class="headerlink" title="1. 修改合约状态变量"></a>1. 修改合约状态变量</h4><p>函数直接修改合约的状态变量（包括赋值、数组/映射的增删改）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract Token &#123;<br>    mapping(address =&gt; uint256) public userBalances;<br>    uint256 public totalSupply;<br><br>    //  mint 代币：修改 totalSupply 和 userBalances → 不能用 view<br>    function mint(address _to, uint256 _amount) public &#123;<br>        totalSupply += _amount;<br>        userBalances[_to] += _amount;<br>    &#125;<br><br>    // 转移余额：修改两个地址的 balance → 不能用 view<br>    function transfer(address _to, uint256 _amount) public &#123;<br>        require(userBalances[msg.sender] &gt;= _amount, &quot;Insufficient balance&quot;);<br>        userBalances[msg.sender] -= _amount;<br>        userBalances[_to] += _amount;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="2-发送-接收ETH（触发转账状态）"><a href="#2-发送-接收ETH（触发转账状态）" class="headerlink" title="2. 发送/接收ETH（触发转账状态）"></a>2. 发送/接收ETH（触发转账状态）</h4><p>函数中包含 <code>transfer</code>、<code>send</code>、<code>call&#123;value: ...&#125;</code> 等转账操作（会修改合约和接收者的ETH余额状态）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract Payment &#123;<br>    address public owner;<br><br>    constructor() &#123;<br>        owner = msg.sender;<br>    &#125;<br><br>    // 提取合约ETH：调用 transfer 修改余额 → 不能用 view<br>    function withdraw() public &#123;<br>        require(msg.sender == owner, &quot;Not owner&quot;);<br>        payable(owner).transfer(address(this).balance);<br>    &#125;<br><br>    // 接收ETH（fallback/receive 函数默认无 view，因会修改合约余额）<br>    receive() external payable &#123;&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="3-调用非-view-pure-的外部函数"><a href="#3-调用非-view-pure-的外部函数" class="headerlink" title="3. 调用非 view/pure 的外部函数"></a>3. 调用非 <code>view</code>/<code>pure</code> 的外部函数</h4><p>函数调用了外部合约中<strong>不带 <code>view</code>/<code>pure</code> 的函数</strong>（即使自身不直接修改状态，也可能通过外部调用触发状态变更）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract ExternalContract &#123;<br>    // 非 view 函数：会修改自身状态<br>    function modifyState() public &#123;<br>        // ... 状态修改逻辑<br>    &#125;<br>&#125;<br><br>contract MyContract &#123;<br>    ExternalContract public externalContract;<br><br>    // 调用外部非 view 函数 → 不能用 view<br>    function callExternal() public &#123;<br>        externalContract.modifyState();<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h4 id="4-执行状态变更操作"><a href="#4-执行状态变更操作" class="headerlink" title="4. 执行状态变更操作"></a>4. 执行状态变更操作</h4><p>函数包含 <code>selfdestruct</code>（销毁合约）、<code>delegatecall</code>（委托调用，可能修改状态）、<code>create2</code>（创建合约）等操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs solidity">contract Destructible &#123;<br>    address public owner;<br><br>    constructor() &#123;<br>        owner = msg.sender;<br>    &#125;<br><br>    // 销毁合约：修改合约状态（销毁后不可用）→ 不能用 view<br>    function destroy() public &#123;<br>        require(msg.sender == owner, &quot;Not owner&quot;);<br>        selfdestruct(payable(owner));<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>


<h3 id="四、关键补充：view-的Gas消耗规则（避免踩坑）"><a href="#四、关键补充：view-的Gas消耗规则（避免踩坑）" class="headerlink" title="四、关键补充：view 的Gas消耗规则（避免踩坑）"></a>四、关键补充：<code>view</code> 的Gas消耗规则（避免踩坑）</h3><ol>
<li><strong>本地调用（off-chain）</strong>：如果通过Web3.js/Ethers.js等库直接调用 <code>view</code> 函数（不发送交易），节点仅本地执行，<strong>不消耗任何Gas</strong>（因为无需上链）；</li>
<li><strong>链上调用（on-chain）</strong>：如果在另一个非 <code>view</code> 函数中调用 <code>view</code> 函数（作为交易的一部分），<code>view</code> 函数的执行会被计入交易Gas（因为整个交易需要上链打包）；</li>
<li>语法允许省略 <code>view</code>：如果函数本应是 <code>view</code> 但省略了修饰符，编译器不会报错，但调用者无法识别其“只读”特性，且本地调用仍会被当作“可能修改状态”处理（无Gas优化），<strong>强烈不推荐省略</strong>。</li>
</ol>
<h3 id="总结：核心判断标准"><a href="#总结：核心判断标准" class="headerlink" title="总结：核心判断标准"></a>总结：核心判断标准</h3><table>
<thead>
<tr>
<th>函数行为</th>
<th>是否用 <code>view</code></th>
</tr>
</thead>
<tbody><tr>
<td>仅读取状态/计算，不修改任何数据</td>
<td>必须用（推荐显式添加）</td>
</tr>
<tr>
<td>修改状态变量、转账、调用非 <code>view</code> 函数</td>
<td>绝对不能用</td>
</tr>
</tbody></table>
<p>简单记：**“读”用 <code>view</code>，“写”不用 <code>view</code>**，显式添加 <code>view</code> 能提升代码可读性、帮助调用者优化Gas，还能让编译器提前拦截非法状态修改。</p>
<h1 id="Your-Goal-User-Mapping-Tokens-你的目标：用户映射代币"><a href="#Your-Goal-User-Mapping-Tokens-你的目标：用户映射代币" class="headerlink" title="Your Goal: User Mapping Tokens 你的目标：用户映射代币"></a>Your Goal: User Mapping Tokens 你的目标：用户映射代币</h1><p>Let’s create a new token where every new user will receive 100 tokens!<br>让我们创建一种新代币，每个新用户都将获得100个代币！</p>
<p>Create a public mapping called users that will map an address to a User struct.<br>创建一个名为users的公共映射，该映射将address映射到User结构体。<br>Create an external function called createUser. This function should create a new user and associate it to the msg.sender address in the users mapping.<br>创建一个名为createUser的外部函数。该函数应创建一个新用户，并将其关联到users映射中的msg.sender地址。<br>The balance of the new user should be set to 100 and the isActive boolean should be set to true.<br>新用户的balance应设置为100，且isActive布尔值应设置为true。</p>
<figure class="highlight zephir"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs zephir"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span><br>pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.20</span>;<br><br>contract Contract &#123;<br>	struct User &#123;<br>		uint256 balance; <span class="hljs-comment">// 用uint256（Solidity 0.8+推荐，避免溢出风险）</span><br>		<span class="hljs-keyword">bool</span> isActive;<br>	&#125;<br>	mapping(address =&gt; User) <span class="hljs-keyword">public</span> users;<br>	<span class="hljs-comment">//User[] public users;</span><br>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createUser</span><span class="hljs-params">()</span> <span class="hljs-title">external</span> </span>&#123;<br>		<span class="hljs-comment">//require(users.bool !== true); 这个写法是错误的</span><br>		<span class="hljs-comment">//保证该函数的地址没有和一个活跃的账户关联</span><br>		<span class="hljs-keyword">require</span>(!users[msg.sender].isActive, <span class="hljs-string">&quot;User already exists (active)&quot;</span>);<br>		<br>		users[msg.sender] = User(<span class="hljs-number">100</span>,<span class="hljs-keyword">true</span>);<br>		<span class="hljs-comment">//新用户的balance应设置为100，且isActive布尔值应设置为true</span><br>		<span class="hljs-comment">//users[msg.sender] = newUser;</span><br>		<span class="hljs-comment">//该函数应创建一个新用户，并将其关联到users映射中的msg.sender地址。</span><br>	&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h1 id="Your-Goal-Transfer-Amount-你的目标：用户映射代币"><a href="#Your-Goal-Transfer-Amount-你的目标：用户映射代币" class="headerlink" title="Your Goal: Transfer Amount 你的目标：用户映射代币"></a>Your Goal: Transfer Amount 你的目标：用户映射代币</h1><p>Create an external function called transfer which takes two parameters: an address for the recipient and a uint for the amount.<br>创建一个名为transfer的外部函数，该函数接受两个参数：一个用于接收者的address和一个用于金额的uint。<br>In this function, transfer the amount specified from the balance of the msg.sender to the balance of the recipient address.<br>在此函数中，将指定的amount从msg.sender的余额转移到接收者address的余额。</p>
<figure class="highlight zephir"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs zephir"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span><br>pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.20</span>;<br><br>contract Contract &#123;<br>	struct User &#123;<br>		uint256 balance; <span class="hljs-comment">// 用uint256（Solidity 0.8+推荐，避免溢出风险）</span><br>		<span class="hljs-keyword">bool</span> isActive;<br>	&#125;<br>	mapping(address =&gt; User) <span class="hljs-keyword">public</span> users;<br>	<span class="hljs-comment">//User[] public users;</span><br>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createUser</span><span class="hljs-params">()</span> <span class="hljs-title">external</span> </span>&#123;<br>		<span class="hljs-comment">//require(users.bool !== true); 这个写法是错误的</span><br>		<span class="hljs-comment">//保证该函数的地址没有和一个活跃的账户关联</span><br>		<span class="hljs-keyword">require</span>(!users[msg.sender].isActive, <span class="hljs-string">&quot;User already exists (active)&quot;</span>);<br>		<br>		users[msg.sender] = User(<span class="hljs-number">100</span>,<span class="hljs-keyword">true</span>);<br>		<span class="hljs-comment">//新用户的balance应设置为100，且isActive布尔值应设置为true</span><br>		<span class="hljs-comment">//users[msg.sender] = newUser;</span><br>		<span class="hljs-comment">//该函数应创建一个新用户，并将其关联到users映射中的msg.sender地址。</span><br>	&#125;<br>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transfer</span><span class="hljs-params">(address addr,<span class="hljs-keyword">uint</span> balance)</span> <span class="hljs-title">external</span> </span>&#123;<br>		<span class="hljs-comment">// 1. 校验调用者（转账方）状态：必须是活跃用户</span><br>		<span class="hljs-keyword">require</span>(users[msg.sender].isActive, <span class="hljs-string">&quot;User already exists (active)&quot;</span>);<br><br>		<span class="hljs-comment">// 2. 校验接收者状态：必须是活跃用户（符合注释要求）</span><br>		<span class="hljs-keyword">require</span>(users[addr].isActive, <span class="hljs-string">&quot;User already exists (active)&quot;</span>);<br><br>		<span class="hljs-comment">// 3. 校验接收者地址有效（非零地址）</span><br>		<span class="hljs-keyword">require</span>(addr != address(<span class="hljs-number">0</span>), <span class="hljs-string">&quot;Recipient address cannot be zero&quot;</span>);<br><br>		<span class="hljs-comment">// 4. 校验转账金额大于0</span><br>		<span class="hljs-keyword">require</span>(balance &gt; <span class="hljs-number">0</span>, <span class="hljs-string">&quot;Transfer amount must be greater than 0&quot;</span>);<br><br>		<span class="hljs-comment">// 5. 校验调用者余额充足</span><br>		<span class="hljs-keyword">require</span>(users[msg.sender].balance &gt;= balance, <span class="hljs-string">&quot;Insufficient balance&quot;</span>);<br><br>		<span class="hljs-comment">//payable(msg.sender,balance,addr);</span><br>		<span class="hljs-comment">//将指定的amount从msg.sender的余额转移到接收者address的余额。</span><br>		users[msg.sender].balance -= balance;  <span class="hljs-comment">// 扣减转账方余额</span><br>    	users[addr].balance += balance;        <span class="hljs-comment">// 增加接收方余额</span><br><br>    	<span class="hljs-comment">// （可选）触发转账事件，方便前端追踪（推荐添加）</span><br>    	<span class="hljs-comment">//emit transfer(msg.sender, addr, balance);</span><br>	&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h1 id="Your-Goal-Make-Connections-你的目标：建立连接"><a href="#Your-Goal-Make-Connections-你的目标：建立连接" class="headerlink" title="Your Goal: Make Connections 你的目标：建立连接"></a>Your Goal: Make Connections 你的目标：建立连接</h1><p>Create a public mapping called connections which will map an address to a mapping of an address to a ConnectionTypes enum value.<br>创建一个名为connections的公共映射，该映射会将一个address映射到另一个从address到ConnectionTypes枚举值的映射。<br>In theconnectWith function, create a connection from the msg.sender to the other address.<br>在connectWith函数中，创建一个从msg.sender到other地址的连接。</p>
<figure class="highlight arcade"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs arcade"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span><br>pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.20</span>;<br><br>contract Contract &#123;<br>	enum ConnectionTypes &#123; <br>		Unacquainted,<br>		Friend,<br>		Family<br>	&#125;<br>	<br>	<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> create a public nested mapping `connections` </span><br>	<span class="hljs-comment">//mapping(address =&gt; User) public connections;</span><br>	mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> ConnectionTypes)) public connections;<br><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">connectWith</span>(<span class="hljs-params">address other, ConnectionTypes connectionType</span>) <span class="hljs-title function_">external</span> &#123;<br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> make the connection from msg.sender =&gt; other =&gt; connectionType</span><br>		<span class="hljs-comment">//connections[msg.sender][ConnectionTypes] = other; 错误的代码</span><br>		require(other != msg.sender, <span class="hljs-string">&quot;Cannot connect with yourself&quot;</span>);<br>		connections[msg.sender][other] = connectionType;<br>	&#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h1 id="Voting-Contract-投票合约"><a href="#Voting-Contract-投票合约" class="headerlink" title="Voting Contract 投票合约"></a>Voting Contract 投票合约</h1><p>In this tutorial we’re going to build a voting contract! We’ll use the lessons learned here to understand how the Governor standard emerged<br>在本教程中，我们将构建一个投票合约！我们会运用在这里学到的知识，来理解Governor标准是如何形成的。</p>
<p> Proposals 提案<br>We’re going to focus on creating a voting contract that will allow members to create new proposals. This contract can contain many proposals which will be voted on by a group of members. Each proposal will keep track of its votes to decide when its time to execute.<br>我们将专注于创建一个投票合约，该合约将允许成员创建新提案。这个合约可以包含许多提案，供一群成员进行投票。每个提案都会记录其票数，以决定何时执行。</p>
<p>At execution time, these proposals will send calldata to a smart contract. The calldata could be anything! We could have a Voting system that allows 100 members to decide when to upgrade a protocol. The calldata might target a function with the signature upgrade(address) and send over the new protocol implementation. That would be a very cool use of your Voting contract!<br>在执行时，这些提案会将调用数据发送到智能合约。调用数据可以是任何内容！我们可以有一个投票系统，允许100名成员决定何时升级协议。调用数据可能会以签名upgrade(address)为目标函数，并发送新的协议实现。这将是对你的投票合约非常酷的一种使用方式！</p>
<h2 id="Your-Goal-Proposals-你的目标：提案"><a href="#Your-Goal-Proposals-你的目标：提案" class="headerlink" title="Your Goal: Proposals 你的目标：提案"></a>Your Goal: Proposals 你的目标：提案</h2><p>Create a public array of type Proposal and call it proposals.<br>创建一个类型为Proposal的公共数组，并将其命名为proposals。<br>Create an external function newProposal which takes two arguments:<br>创建一个外部函数newProposal，它接受两个参数：<br>An address argument which will be the target address of the proposal. We’ll send some calldata to this address.<br>一个address参数，它将是提案的目标地址。我们会向这个地址发送一些调用数据。<br>A bytes argument which will be the calldata to eventually send to the smart contract when the proposal is executed.<br>一个bytes参数，它将是提案执行时最终发送给智能合约的调用数据。<br>In the newProposal function create a new Proposal with the arguments passed in and the yes/no vote counts are initialized at 0.<br>在newProposal函数中，使用传入的参数创建一个新的Proposal，赞成/反对票数初始化为0。<br>Add the new Proposal to the proposals array.<br>将新的Proposal添加到proposals数组中。</p>
<figure class="highlight d"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs d"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span><br><span class="hljs-keyword">pragma</span> solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.20</span>;<br><br>contract Voting &#123;<br>    <span class="hljs-keyword">struct</span> Proposal &#123;<br>        address target;<br>        bytes data;<br>        <span class="hljs-built_in">uint</span> yesCount;<br>        <span class="hljs-built_in">uint</span> noCount;<br>    &#125;<br>    <span class="hljs-comment">//Proposal[] public = proposals; 这样写是错误的</span><br>    Proposal[] <span class="hljs-keyword">public</span> proposals; <span class="hljs-comment">// 语法：数组类型 可见性 变量名;</span><br>    <span class="hljs-comment">//创建一个类型为Proposal的公共数组，并将其命名为proposals。</span><br>    <span class="hljs-built_in">function</span> newProposal(address addr, bytes calldata data) external &#123;<br>        <span class="hljs-comment">//创建一个外部函数newProposal，它接受两个参数</span><br>        <span class="hljs-comment">//一个address参数，它将是提案的目标地址。我们会向这个地址发送一些调用数据。</span><br>        <span class="hljs-comment">//一个bytes参数，它将是提案执行时最终发送给智能合约的调用数据。</span><br>        <span class="hljs-comment">//Proposal = Proposal[addr,data,0,0]; Proposal 是类型名，不能直接用 类型名 = 类型名[参数] 创建实例（这是其他语言的语法，Solidity 不支持）</span><br>        Proposal memory newProposalInstance = Proposal(addr,data,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">//在newProposal函数中，使用传入的参数创建一个新的Proposal，赞成/反对票数初始化为0。</span><br>        proposals.push(newProposalInstance);<br>    &#125;<br>&#125;<br><br></code></pre></div></td></tr></table></figure>

<h2 id="calldata的问题"><a href="#calldata的问题" class="headerlink" title="calldata的问题"></a>calldata的问题</h2><p><code>function newProposal(address addr, bytes calldata data) external &#123;</code></p>
<p>在 Solidity 中，<code>calldata</code> 是一个特殊的数据存储位置，专门用于函数参数，尤其是外部函数（<code>external</code>）的参数。它是只读的，具有一定的效率和燃气优化优势。</p>
<h3 id="为什么需要使用-calldata？"><a href="#为什么需要使用-calldata？" class="headerlink" title="为什么需要使用 calldata？"></a>为什么需要使用 <code>calldata</code>？</h3><ol>
<li><p><strong>函数签名和燃气效率</strong></p>
<ul>
<li>当一个函数被标记为 <code>external</code> 时，函数的参数是从外部传入的。参数通常存储在 <code>memory</code> 或 <code>storage</code> 中，取决于如何处理。而 <code>calldata</code> 是一个为外部函数调用优化的数据位置，它直接从交易输入数据中读取，这样可以减少燃气消耗。</li>
<li>在你提供的例子中，<code>data</code> 参数是通过外部函数调用传递的。使用 <code>calldata</code> 可以确保该参数直接从交易输入数据中获取，而不需要复制到 <code>memory</code> 中，这样节省了燃气。</li>
</ul>
</li>
<li><p><strong><code>calldata</code> 是只读的</strong></p>
<ul>
<li><code>calldata</code> 是一个只读数据存储位置，意味着它不能在函数中被修改。这对于只读取传入数据的函数来说非常合适。在你这个例子中，<code>data</code> 参数看起来只是用来读取的，所以使用 <code>calldata</code> 确保了数据的不可变性，并且 Solidity 编译器会相应地进行优化。</li>
<li>相比之下，<code>memory</code> 是一个临时数据存储位置，允许修改，但使用 <code>memory</code> 比使用 <code>calldata</code> 更加消耗燃气。</li>
</ul>
</li>
<li><p><strong>外部函数调用的优化</strong></p>
<ul>
<li>对于 <code>external</code> 函数，Solidity 会优化它们与其他合约的交互，而 <code>calldata</code> 是这种优化的核心部分。通过使用 <code>calldata</code>，数据不需要被复制到其他地方，因此可以减少内存和存储开销。</li>
</ul>
</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>使用 <code>calldata</code> 可以提高函数参数的读取效率，减少燃气费用，因为它是专为外部调用设计的，只读且不需要复制到 <code>memory</code> 中。</p>
<h1 id="Your-Goal-Cast-Vote-你的目标：投票"><a href="#Your-Goal-Cast-Vote-你的目标：投票" class="headerlink" title="Your Goal: Cast Vote 你的目标：投票"></a>Your Goal: Cast Vote 你的目标：投票</h1><p>Create an external function castVote which takes a uint proposalId and a bool which indicates whether the vote supports the proposal (true for yes, false for no).<br>创建一个外部函数castVote，它接收一个uint类型的proposalId和一个bool类型的参数，该参数用于表示投票是否支持该提案（true表示赞成，false表示反对）。<br>For each vote cast, update the yesCount and noCount in the referenced proposal accordingly.<br>对于每一张所投的票，相应地更新所引用提案中的yesCount和noCount。</p>
<figure class="highlight zephir"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs zephir"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span><br>pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.20</span>;<br><br>contract Voting &#123;<br>    struct Proposal &#123;<br>        address target;<br>        bytes data;<br>        <span class="hljs-keyword">uint</span> yesCount;<br>        <span class="hljs-keyword">uint</span> noCount;<br>    &#125;<br>    <span class="hljs-comment">//Proposal[] public = proposals; 这样写是错误的</span><br>    Proposal[] <span class="hljs-keyword">public</span> proposals; <span class="hljs-comment">// 语法：数组类型 可见性 变量名;</span><br>    <span class="hljs-comment">//创建一个类型为Proposal的公共数组，并将其命名为proposals。</span><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newProposal</span><span class="hljs-params">(address addr, bytes calldata data)</span> <span class="hljs-title">external</span> </span>&#123;<br>        <span class="hljs-comment">//创建一个外部函数newProposal，它接受两个参数</span><br>        <span class="hljs-comment">//一个address参数，它将是提案的目标地址。我们会向这个地址发送一些调用数据。</span><br>        <span class="hljs-comment">//一个bytes参数，它将是提案执行时最终发送给智能合约的调用数据。</span><br>        <span class="hljs-comment">//Proposal = Proposal[addr,data,0,0]; Proposal 是类型名，不能直接用 类型名 = 类型名[参数] 创建实例（这是其他语言的语法，Solidity 不支持）</span><br>        Proposal memory newProposalInstance = Proposal(addr,data,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">//在newProposal函数中，使用传入的参数创建一个新的Proposal，赞成/反对票数初始化为0。</span><br>        proposals.push(newProposalInstance);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">castVote</span><span class="hljs-params">(<span class="hljs-keyword">uint</span> proposalId, <span class="hljs-keyword">bool</span> support)</span> <span class="hljs-title">external</span> </span>&#123;<br>    <span class="hljs-comment">//创建一个外部函数castVote，它接收一个uint类型的proposalId和一个bool类型的参数，该参数用于表示投票是否支持该提案（true表示赞成，false表示反对）</span><br>        <span class="hljs-comment">//对于每一张所投的票，相应地更新所引用提案中的yesCount和noCount</span><br>        <span class="hljs-comment">// 1. 校验：提案是否存在（proposalId 从 0 开始，需小于数组长度）</span><br>        <span class="hljs-keyword">require</span>(proposalId &lt; proposals.length, <span class="hljs-string">&quot;proposal not exist&quot;</span>);<br>    <br>        <span class="hljs-comment">// 2. 校验：是否已投票（防止重复投票）</span><br>        <span class="hljs-comment">//require(!hasVoted[proposalId][msg.sender], &quot;has voted&quot;);</span><br>    <br>        <span class="hljs-comment">// 3. 找到已存在的提案（用 storage 引用，直接修改链上数据，不用新建）</span><br>        Proposal storage targetProposal = proposals[proposalId];<br><br>        <span class="hljs-keyword">if</span> (support == <span class="hljs-keyword">true</span>) &#123;<br>            targetProposal.yesCount += <span class="hljs-number">1</span>;<br><br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            targetProposal.noCount += <span class="hljs-number">1</span>;   <span class="hljs-comment">// 反对：noCount +1</span><br>        &#125;<br>        <span class="hljs-comment">//hasVoted[proposalId][msg.sender] = true;</span><br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>



            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Web3/">Web3</a>
                    
                  </div>
                
              </div>
              
                
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/12/16/2b2012d98e77/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">关于招聘</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/12/15/246f7b509074/">
                        <span class="hidden-mobile">university.alchemy6</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


            

                
                  <a id="scroll-top-button" href="#" role="button">
                    <i class="iconfont icon-arrowup" aria-hidden="true"></i>
                  </a>
                  

                    

                          
      </main>

      <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://whale3070.github.io/" target="_blank" rel="nofollow noopener"><span>Whale3070</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
  <script src="/pagefind/pagefind-ui.js"></script>
  <style>
    /* 搜索框配色适配 */
    #search { margin-top: 2rem; }
    [data-user-color-scheme='dark'] .pagefind-ui {
      --pagefind-ui-primary: #eeeeee;
      --pagefind-ui-text: #eeeeee;
      --pagefind-ui-background: #151515;
      --pagefind-ui-border: #333;
    }
  </style>
    </body>

  </html>